/*
 * Falcon signature verification.
 *
 * ==========================(LICENSE BEGIN)============================
 *
 * Copyright (c) 2017  Falcon Project
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * ===========================(LICENSE END)=============================
 *
 * @author   Thomas Pornin <thomas.pornin@nccgroup.trust>
 */

#include "internal.h"

/* ===================================================================== */
/*
 * Constants for NTT.
 *
 * Binary case:
 *   n = 2^logn  (2 <= n <= 1024)
 *   phi = X^n + 1
 *   q = 12289
 *
 * Ternary case:
 *   n = 1.5*2^n  (6 <= n <= 768)
 *   phi = X^n - X^(n/2) + 1
 *   q = 18433
 *
 * In both cases:
 *   q0i = -1/q mod 2^16
 *   R = 2^16 mod q
 *   R2 = 2^32 mod q
 */

#define Qb     12289
#define Q0Ib   12287
#define Rb      4091
#define R2b    10952

#define Qt     18433
#define Q0It   18431
#define Rt     10237
#define R2t     4564

/*
 * Inverse of n = 1.5*2^logn modulo q, for the ternary case. Values are
 * in Montogmery representation. This is defined only for logn from 2 to 9.
 */
static const uint16_t INVNQt[] = {
	0, 0, 17067, 17750, 8875, 13654, 6827, 12630, 6315, 12374
};

/*
 * Table for NTT, binary case:
 *   GMb[x] = R*(g^rev(x)) mod q
 * where g = 7 (it is a 2048-th primitive root of 1 modulo q)
 * and rev() is the bit-reversal function over 10 bits.
 */
static const uint16_t GMb[] = {
	 4091,  7888, 11060, 11208,  6960,  4342,  6275,  9759,
	 1591,  6399,  9477,  5266,   586,  5825,  7538,  9710,
	 1134,  6407,  1711,   965,  7099,  7674,  3743,  6442,
	10414,  8100,  1885,  1688,  1364, 10329, 10164,  9180,
	12210,  6240,   997,   117,  4783,  4407,  1549,  7072,
	 2829,  6458,  4431,  8877,  7144,  2564,  5664,  4042,
	12189,   432, 10751,  1237,  7610,  1534,  3983,  7863,
	 2181,  6308,  8720,  6570,  4843,  1690,    14,  3872,
	 5569,  9368, 12163,  2019,  7543,  2315,  4673,  7340,
	 1553,  1156,  8401, 11389,  1020,  2967, 10772,  7045,
	 3316, 11236,  5285, 11578, 10637, 10086,  9493,  6180,
	 9277,  6130,  3323,   883, 10469,   489,  1502,  2851,
	11061,  9729,  2742, 12241,  4970, 10481, 10078,  1195,
	  730,  1762,  3854,  2030,  5892, 10922,  9020,  5274,
	 9179,  3604,  3782, 10206,  3180,  3467,  4668,  2446,
	 7613,  9386,   834,  7703,  6836,  3403,  5351, 12276,
	 3580,  1739, 10820,  9787, 10209,  4070, 12250,  8525,
	10401,  2749,  7338, 10574,  6040,   943,  9330,  1477,
	 6865,  9668,  3585,  6633, 12145,  4063,  3684,  7680,
	 8188,  6902,  3533,  9807,  6090,   727, 10099,  7003,
	 6945,  1949,  9731, 10559,  6057,   378,  7871,  8763,
	 8901,  9229,  8846,  4551,  9589, 11664,  7630,  8821,
	 5680,  4956,  6251,  8388, 10156,  8723,  2341,  3159,
	 1467,  5460,  8553,  7783,  2649,  2320,  9036,  6188,
	  737,  3698,  4699,  5753,  9046,  3687,    16,   914,
	 5186, 10531,  4552,  1964,  3509,  8436,  7516,  5381,
	10733,  3281,  7037,  1060,  2895,  7156,  8887,  5357,
	 6409,  8197,  2962,  6375,  5064,  6634,  5625,   278,
	  932, 10229,  8927,  7642,   351,  9298,   237,  5858,
	 7692,  3146, 12126,  7586,  2053, 11285,  3802,  5204,
	 4602,  1748, 11300,   340,  3711,  4614,   300, 10993,
	 5070, 10049, 11616, 12247,  7421, 10707,  5746,  5654,
	 3835,  5553,  1224,  8476,  9237,  3845,   250, 11209,
	 4225,  6326,  9680, 12254,  4136,  2778,   692,  8808,
	 6410,  6718, 10105, 10418,  3759,  7356, 11361,  8433,
	 6437,  3652,  6342,  8978,  5391,  2272,  6476,  7416,
	 8418, 10824, 11986,  5733,   876,  7030,  2167,  2436,
	 3442,  9217,  8206,  4858,  5964,  2746,  7178,  1434,
	 7389,  8879, 10661, 11457,  4220,  1432, 10832,  4328,
	 8557,  1867,  9454,  2416,  3816,  9076,   686,  5393,
	 2523,  4339,  6115,   619,   937,  2834,  7775,  3279,
	 2363,  7488,  6112,  5056,   824, 10204, 11690,  1113,
	 2727,  9848,   896,  2028,  5075,  2654, 10464,  7884,
	12169,  5434,  3070,  6400,  9132, 11672, 12153,  4520,
	 1273,  9739, 11468,  9937, 10039,  9720,  2262,  9399,
	11192,   315,  4511,  1158,  6061,  6751, 11865,   357,
	 7367,  4550,   983,  8534,  8352, 10126,  7530,  9253,
	 4367,  5221,  3999,  8777,  3161,  6990,  4130, 11652,
	 3374, 11477,  1753,   292,  8681,  2806, 10378, 12188,
	 5800, 11811,  3181,  1988,  1024,  9340,  2477, 10928,
	 4582,  6750,  3619,  5503,  5233,  2463,  8470,  7650,
	 7964,  6395,  1071,  1272,  3474, 11045,  3291, 11344,
	 8502,  9478,  9837,  1253,  1857,  6233,  4720, 11561,
	 6034,  9817,  3339,  1797,  2879,  6242,  5200,  2114,
	 7962,  9353, 11363,  5475,  6084,  9601,  4108,  7323,
	10438,  9471,  1271,   408,  6911,  3079,   360,  8276,
	11535,  9156,  9049, 11539,   850,  8617,   784,  7919,
	 8334, 12170,  1846, 10213, 12184,  7827, 11903,  5600,
	 9779,  1012,   721,  2784,  6676,  6552,  5348,  4424,
	 6816,  8405,  9959,  5150,  2356,  5552,  5267,  1333,
	 8801,  9661,  7308,  5788,  4910,   909, 11613,  4395,
	 8238,  6686,  4302,  3044,  2285, 12249,  1963,  9216,
	 4296, 11918,   695,  4371,  9793,  4884,  2411, 10230,
	 2650,   841,  3890, 10231,  7248,  8505, 11196,  6688,
	 4059,  6060,  3686,  4722, 11853,  5816,  7058,  6868,
	11137,  7926,  4894, 12284,  4102,  3908,  3610,  6525,
	 7938,  7982, 11977,  6755,   537,  4562,  1623,  8227,
	11453,  7544,   906, 11816,  9548, 10858,  9703,  2815,
	11736,  6813,  6979,   819,  8903,  6271, 10843,   348,
	 7514,  8339,  6439,   694,   852,  5659,  2781,  3716,
	11589,  3024,  1523,  8659,  4114, 10738,  3303,  5885,
	 2978,  7289, 11884,  9123,  9323, 11830,    98,  2526,
	 2116,  4131, 11407,  1844,  3645,  3916,  8133,  2224,
	10871,  8092,  9651,  5989,  7140,  8480,  1670,   159,
	10923,  4918,   128,  7312,   725,  9157,  5006,  6393,
	 3494,  6043, 10972,  6181, 11838,  3423, 10514,  7668,
	 3693,  6658,  6905, 11953, 10212, 11922,  9101,  8365,
	 5110,    45,  2400,  1921,  4377,  2720,  1695,    51,
	 2808,   650,  1896,  9997,  9971, 11980,  8098,  4833,
	 4135,  4257,  5838,  4765, 10985, 11532,   590, 12198,
	  482, 12173,  2006,  7064, 10018,  3912, 12016, 10519,
	11362,  6954,  2210,   284,  5413,  6601,  3865, 10339,
	11188,  6231,   517,  9564, 11281,  3863,  1210,  4604,
	 8160, 11447,   153,  7204,  5763,  5089,  9248, 12154,
	11748,  1354,  6672,   179,  5532,  2646,  5941, 12185,
	  862,  3158,   477,  7279,  5678,  7914,  4254,   302,
	 2893, 10114,  6890,  9560,  9647, 11905,  4098,  9824,
	10269,  1353, 10715,  5325,  6254,  3951,  1807,  6449,
	 5159,  1308,  8315,  3404,  1877,  1231,   112,  6398,
	11724, 12272,  7286,  1459, 12274,  9896,  3456,   800,
	 1397, 10678,   103,  7420,  7976,   936,   764,   632,
	 7996,  8223,  8445,  7758, 10870,  9571,  2508,  1946,
	 6524, 10158,  1044,  4338,  2457,  3641,  1659,  4139,
	 4688,  9733, 11148,  3946,  2082,  5261,  2036, 11850,
	 7636, 12236,  5366,  2380,  1399,  7720,  2100,  3217,
	10912,  8898,  7578, 11995,  2791,  1215,  3355,  2711,
	 2267,  2004,  8568, 10176,  3214,  2337,  1750,  4729,
	 4997,  7415,  6315, 12044,  4374,  7157,  4844,   211,
	 8003, 10159,  9290, 11481,  1735,  2336,  5793,  9875,
	 8192,   986,  7527,  1401,   870,  3615,  8465,  2756,
	 9770,  2034, 10168,  3264,  6132,    54,  2880,  4763,
	11805,  3074,  8286,  9428,  4881,  6933,  1090, 10038,
	 2567,   708,   893,  6465,  4962, 10024,  2090,  5718,
	10743,   780,  4733,  4623,  2134,  2087,  4802,   884,
	 5372,  5795,  5938,  4333,  6559,  7549,  5269, 10664,
	 4252,  3260,  5917, 10814,  5768,  9983,  8096,  7791,
	 6800,  7491,  6272,  1907, 10947,  6289, 11803,  6032,
	11449,  1171,  9201,  7933,  2479,  7970, 11337,  7062,
	 8911,  6728,  6542,  8114,  8828,  6595,  3545,  4348,
	 4610,  2205,  6999,  8106,  5560, 10390,  9321,  2499,
	 2413,  7272,  6881, 10582,  9308,  9437,  3554,  3326,
	 5991, 11969,  3415, 12283,  9838, 12063,  4332,  7830,
	11329,  6605, 12271,  2044, 11611,  7353, 11201, 11582,
	 3733,  8943,  9978,  1627,  7168,  3935,  5050,  2762,
	 7496, 10383,   755,  1654, 12053,  4952, 10134,  4394,
	 6592,  7898,  7497,  8904, 12029,  3581, 10748,  5674,
	10358,  4901,  7414,  8771,   710,  6764,  8462,  7193,
	 5371,  7274, 11084,   290,  7864,  6827, 11822,  2509,
	 6578,  4026,  5807,  1458,  5721,  5762,  4178,  2105,
	11621,  4852,  8897,  2856, 11510,  9264,  2520,  8776,
	 7011,  2647,  1898,  7039,  5950, 11163,  5488,  6277,
	 9182, 11456,   633, 10046, 11554,  5633,  9587,  2333,
	 7008,  7084,  5047,  7199,  9865,  8997,   569,  6390,
	10845,  9679,  8268, 11472,  4203,  1997,     2,  9331,
	  162,  6182,  2000,  3649,  9792,  6363,  7557,  6187,
	 8510,  9935,  5536,  9019,  3706, 12009,  1452,  3067,
	 5494,  9692,  4865,  6019,  7106,  9610,  4588, 10165,
	 6261,  5887,  2652, 10172,  1580, 10379,  4638,  9949
};

/*
 * Table for inverse NTT, binary case:
 *   iGMb[x] = R*((1/g)^rev(x)) mod q
 * Since g = 7, 1/g = 8778 mod 12289.
 */
static const uint32_t iGMb[] = {
	 4091,  4401,  1081,  1229,  2530,  6014,  7947,  5329,
	 2579,  4751,  6464, 11703,  7023,  2812,  5890, 10698,
	 3109,  2125,  1960, 10925, 10601, 10404,  4189,  1875,
	 5847,  8546,  4615,  5190, 11324, 10578,  5882, 11155,
	 8417, 12275, 10599,  7446,  5719,  3569,  5981, 10108,
	 4426,  8306, 10755,  4679, 11052,  1538, 11857,   100,
	 8247,  6625,  9725,  5145,  3412,  7858,  5831,  9460,
	 5217, 10740,  7882,  7506, 12172, 11292,  6049,    79,
	   13,  6938,  8886,  5453,  4586, 11455,  2903,  4676,
	 9843,  7621,  8822,  9109,  2083,  8507,  8685,  3110,
	 7015,  3269,  1367,  6397, 10259,  8435, 10527, 11559,
	11094,  2211,  1808,  7319,    48,  9547,  2560,  1228,
	 9438, 10787, 11800,  1820, 11406,  8966,  6159,  3012,
	 6109,  2796,  2203,  1652,   711,  7004,  1053,  8973,
	 5244,  1517,  9322, 11269,   900,  3888, 11133, 10736,
	 4949,  7616,  9974,  4746, 10270,   126,  2921,  6720,
	 6635,  6543,  1582,  4868,    42,   673,  2240,  7219,
	 1296, 11989,  7675,  8578, 11949,   989, 10541,  7687,
	 7085,  8487,  1004, 10236,  4703,   163,  9143,  4597,
	 6431, 12052,  2991, 11938,  4647,  3362,  2060, 11357,
	12011,  6664,  5655,  7225,  5914,  9327,  4092,  5880,
	 6932,  3402,  5133,  9394, 11229,  5252,  9008,  1556,
	 6908,  4773,  3853,  8780, 10325,  7737,  1758,  7103,
	11375, 12273,  8602,  3243,  6536,  7590,  8591, 11552,
	 6101,  3253,  9969,  9640,  4506,  3736,  6829, 10822,
	 9130,  9948,  3566,  2133,  3901,  6038,  7333,  6609,
	 3468,  4659,   625,  2700,  7738,  3443,  3060,  3388,
	 3526,  4418, 11911,  6232,  1730,  2558, 10340,  5344,
	 5286,  2190, 11562,  6199,  2482,  8756,  5387,  4101,
	 4609,  8605,  8226,   144,  5656,  8704,  2621,  5424,
	10812,  2959, 11346,  6249,  1715,  4951,  9540,  1888,
	 3764,    39,  8219,  2080,  2502,  1469, 10550,  8709,
	 5601,  1093,  3784,  5041,  2058,  8399, 11448,  9639,
	 2059,  9878,  7405,  2496,  7918, 11594,   371,  7993,
	 3073, 10326,    40, 10004,  9245,  7987,  5603,  4051,
	 7894,   676, 11380,  7379,  6501,  4981,  2628,  3488,
	10956,  7022,  6737,  9933,  7139,  2330,  3884,  5473,
	 7865,  6941,  5737,  5613,  9505, 11568, 11277,  2510,
	 6689,   386,  4462,   105,  2076, 10443,   119,  3955,
	 4370, 11505,  3672, 11439,   750,  3240,  3133,   754,
	 4013, 11929,  9210,  5378, 11881, 11018,  2818,  1851,
	 4966,  8181,  2688,  6205,  6814,   926,  2936,  4327,
	10175,  7089,  6047,  9410, 10492,  8950,  2472,  6255,
	  728,  7569,  6056, 10432, 11036,  2452,  2811,  3787,
	  945,  8998,  1244,  8815, 11017, 11218,  5894,  4325,
	 4639,  3819,  9826,  7056,  6786,  8670,  5539,  7707,
	 1361,  9812,  2949, 11265, 10301,  9108,   478,  6489,
	  101,  1911,  9483,  3608, 11997, 10536,   812,  8915,
	  637,  8159,  5299,  9128,  3512,  8290,  7068,  7922,
	 3036,  4759,  2163,  3937,  3755, 11306,  7739,  4922,
	11932,   424,  5538,  6228, 11131,  7778, 11974,  1097,
	 2890, 10027,  2569,  2250,  2352,   821,  2550, 11016,
	 7769,   136,   617,  3157,  5889,  9219,  6855,   120,
	 4405,  1825,  9635,  7214, 10261, 11393,  2441,  9562,
	11176,   599,  2085, 11465,  7233,  6177,  4801,  9926,
	 9010,  4514,  9455, 11352, 11670,  6174,  7950,  9766,
	 6896, 11603,  3213,  8473,  9873,  2835, 10422,  3732,
	 7961,  1457, 10857,  8069,   832,  1628,  3410,  4900,
	10855,  5111,  9543,  6325,  7431,  4083,  3072,  8847,
	 9853, 10122,  5259, 11413,  6556,   303,  1465,  3871,
	 4873,  5813, 10017,  6898,  3311,  5947,  8637,  5852,
	 3856,   928,  4933,  8530,  1871,  2184,  5571,  5879,
	 3481, 11597,  9511,  8153,    35,  2609,  5963,  8064,
	 1080, 12039,  8444,  3052,  3813, 11065,  6736,  8454,
	 2340,  7651,  1910, 10709,  2117,  9637,  6402,  6028,
	 2124,  7701,  2679,  5183,  6270,  7424,  2597,  6795,
	 9222, 10837,   280,  8583,  3270,  6753,  2354,  3779,
	 6102,  4732,  5926,  2497,  8640, 10289,  6107, 12127,
	 2958, 12287, 10292,  8086,   817,  4021,  2610,  1444,
	 5899, 11720,  3292,  2424,  5090,  7242,  5205,  5281,
	 9956,  2702,  6656,   735,  2243, 11656,   833,  3107,
	 6012,  6801,  1126,  6339,  5250, 10391,  9642,  5278,
	 3513,  9769,  3025,   779,  9433,  3392,  7437,   668,
	10184,  8111,  6527,  6568, 10831,  6482,  8263,  5711,
	 9780,   467,  5462,  4425, 11999,  1205,  5015,  6918,
	 5096,  3827,  5525, 11579,  3518,  4875,  7388,  1931,
	 6615,  1541,  8708,   260,  3385,  4792,  4391,  5697,
	 7895,  2155,  7337,   236, 10635, 11534,  1906,  4793,
	 9527,  7239,  8354,  5121, 10662,  2311,  3346,  8556,
	  707,  1088,  4936,   678, 10245,    18,  5684,   960,
	 4459,  7957,   226,  2451,     6,  8874,   320,  6298,
	 8963,  8735,  2852,  2981,  1707,  5408,  5017,  9876,
	 9790,  2968,  1899,  6729,  4183,  5290, 10084,  7679,
	 7941,  8744,  5694,  3461,  4175,  5747,  5561,  3378,
	 5227,   952,  4319,  9810,  4356,  3088, 11118,   840,
	 6257,   486,  6000,  1342, 10382,  6017,  4798,  5489,
	 4498,  4193,  2306,  6521,  1475,  6372,  9029,  8037,
	 1625,  7020,  4740,  5730,  7956,  6351,  6494,  6917,
	11405,  7487, 10202, 10155,  7666,  7556, 11509,  1546,
	 6571, 10199,  2265,  7327,  5824, 11396, 11581,  9722,
	 2251, 11199,  5356,  7408,  2861,  4003,  9215,   484,
	 7526,  9409, 12235,  6157,  9025,  2121, 10255,  2519,
	 9533,  3824,  8674, 11419, 10888,  4762, 11303,  4097,
	 2414,  6496,  9953, 10554,   808,  2999,  2130,  4286,
	12078,  7445,  5132,  7915,   245,  5974,  4874,  7292,
	 7560, 10539,  9952,  9075,  2113,  3721, 10285, 10022,
	 9578,  8934, 11074,  9498,   294,  4711,  3391,  1377,
	 9072, 10189,  4569, 10890,  9909,  6923,    53,  4653,
	  439, 10253,  7028, 10207,  8343,  1141,  2556,  7601,
	 8150, 10630,  8648,  9832,  7951, 11245,  2131,  5765,
	10343,  9781,  2718,  1419,  4531,  3844,  4066,  4293,
	11657, 11525, 11353,  4313,  4869, 12186,  1611, 10892,
	11489,  8833,  2393,    15, 10830,  5003,    17,   565,
	 5891, 12177, 11058, 10412,  8885,  3974, 10981,  7130,
	 5840, 10482,  8338,  6035,  6964,  1574, 10936,  2020,
	 2465,  8191,   384,  2642,  2729,  5399,  2175,  9396,
	11987,  8035,  4375,  6611,  5010, 11812,  9131, 11427,
	  104,  6348,  9643,  6757, 12110,  5617, 10935,   541,
	  135,  3041,  7200,  6526,  5085, 12136,   842,  4129,
	 7685, 11079,  8426,  1008,  2725, 11772,  6058,  1101,
	 1950,  8424,  5688,  6876, 12005, 10079,  5335,   927,
	 1770,   273,  8377,  2271,  5225, 10283,   116, 11807,
	   91, 11699,   757,  1304,  7524,  6451,  8032,  8154,
	 7456,  4191,   309,  2318,  2292, 10393, 11639,  9481,
	12238, 10594,  9569,  7912, 10368,  9889, 12244,  7179,
	 3924,  3188,   367,  2077,   336,  5384,  5631,  8596,
	 4621,  1775,  8866,   451,  6108,  1317,  6246,  8795,
	 5896,  7283,  3132, 11564,  4977, 12161,  7371,  1366,
	12130, 10619,  3809,  5149,  6300,  2638,  4197,  1418,
	10065,  4156,  8373,  8644, 10445,   882,  8158, 10173,
	 9763, 12191,   459,  2966,  3166,   405,  5000,  9311,
	 6404,  8986,  1551,  8175,  3630, 10766,  9265,   700,
	 8573,  9508,  6630, 11437, 11595,  5850,  3950,  4775,
	11941,  1446,  6018,  3386, 11470,  5310,  5476,   553,
	 9474,  2586,  1431,  2741,   473, 11383,  4745,   836,
	 4062, 10666,  7727, 11752,  5534,   312,  4307,  4351,
	 5764,  8679,  8381,  8187,     5,  7395,  4363,  1152,
	 5421,  5231,  6473,   436,  7567,  8603,  6229,  8230
};

/*
 * Tables for NTT and inverse NTT, ternary case.
 *
 *   GMt_square: for degree halving and doubling (inverse: iGMt_square)
 *   GMt_cubic: for ternary split/merge (inverse: iGMt_cubic)
 */

static const uint16_t GMt_square[] = {
	 9358,  9358,  8086, 11703,  5774, 14509, 12722,  9851,
	16750, 12828,  7852,   806,  1458, 10770,  9265, 12609,
	 8775,  1328, 14458, 11372,  1705,  1823,  7105,  6894,
	 9026,    72, 11666,  7057,  4201,  8427, 18263, 14143,
	11872,  6834,  4390,  7775, 13188, 11852, 17658,  7550,
	 8671,  4125, 12457, 11838, 14110,  5843,  1013, 16889,
	15905,  5600, 12331, 18417,  5191,  4134,  9307, 10416,
	  141, 17654, 14588, 12484,   374,  9438, 14640,  1869,
	17998, 16130, 13431, 13647,  6690,  6180, 12094,   509,
	12223, 13523,  4231,  1594,  5883,  7501, 10569, 12987,
	17487, 15162,  2004,   694,  7557,  9626,  4139,  9031,
	10013, 13052,  3184,  2280,  6819,   761, 10145,  8793,
	15397,  5792,   430,  6514,  4105,  8173, 14998, 17409,
	 9415, 15310,  5503, 14176,  9024,  5443, 11982,  6357,
	 4076,  3104,  1147,  7259,   876,  6926,  9056, 11672,
	 8610, 11260,  3662,  8921, 16955,  6074, 12328, 17257,
	18117,   700, 13062, 18431,  2953,  5125, 12684,  1302,
	 6930,  6815, 11040, 10777,  4655,  5788,  1830,  7146,
	 5330,  8726,  5778,  3767, 14007, 15171, 17287, 17705,
	16342,  2532, 17017,  5470, 15632, 10638,   166, 15032,
	 3832, 13211,  2833, 14024, 12256,  7850, 17450, 13144,
	14661,  9989,  6120,  6976,  3983,  4010, 15841, 11575,
	 8164, 10848,   398,   285, 12373, 16224, 17397, 17228,
	 7857, 15028, 12038,  3433,  9467,  4695, 15720, 13943,
	 4443,  3691, 16893,  6678,  1588, 11882,  7158,  2810,
	12578,  9470,  3440, 15246, 14407, 10085,  9386, 10241,
	 9408,  6459,  6609, 11726, 13581, 16348, 10863, 16069,
	14175,  6399,  9176,  2773,  7008,   109, 17149,  1211,
	15887, 17073, 15175, 12117, 16909,   576,  1163,  1157,
	 4969, 10459,  7517,  6448,  9389, 11401,  9611,  5076,
	 2811, 17806, 16687,  6901, 13339,  2651, 12233,  5101,
	14069, 14567,  7491,  2539,  2282,  9878,  8104,  6081
};

static const uint16_t GMt_cubic[] = {
	    0,     0,  5863, 13355,  3451, 10413, 17691,  5912,
	 1638, 13729,   651,  6638,  5184, 14889,  7732, 13716,
	 6193, 12464,  2225,  4481,  6221, 17110, 16888,  3019,
	18432,  3784, 17251, 11902,  2776,  2426,   158, 10417,
	 2894, 16739, 10603,  6889,  3044,  2129,  3573,  9590,
	 9271, 14968,  9120, 14929, 14605, 15247,  9822, 12913,
	 5467, 13131, 10444,   256, 12400,  8818,  2565,  8231,
	 1966,  7588,  1254, 10578, 16985,  4631,  2733, 17674,
	 8301, 17281,  5426,  2378, 16107,  9043, 15618, 16119,
	12790,  7698,  2720, 11567, 15351, 12632,  6810,   294,
	 3399,  4418, 17657,  5537,  2072, 12010, 15948,  2410,
	16169, 14064, 15170, 15515, 17644, 17863,  7485,  8281,
	14259, 15768,  6376,  2013, 11100,  6407, 14337, 15544,
	11571, 12144, 18069, 13334,  7623,  2213, 15082, 16713,
	 5319,  1740,  1405, 10617, 17722, 17639,  7516,  1575,
	 3339, 10262,  2036,   770,  2735, 10106,  6995,   708,
	10542, 16517, 18369,  2547,  7012, 10112, 11767,  7800,
	16536,  7811,  6572, 16102, 12667, 12305,  4798,   873,
	 2005,  7476, 10486,  7225,   886,  2182, 15004, 16937,
	 4939,  1886, 13070, 17292,  3488, 17869, 12257, 15373,
	 7292,  1273, 10933, 11613, 15275,  5288,  9143,  1629,
	11564,  1766,  9795,  4483,  8622,   762, 16188, 15900,
	14917, 14351,  9946,  4522,  9359, 13770,  2538, 18234,
	 6214,  6732,  8614, 12601,  3224,  3030, 13570,  5458,
	11553,  6524, 15226,  6374,  2292,  9015, 17926,  1456,
	 6036, 16696,   981, 11362, 18094, 10899,  4828, 16384,
	 2832, 11718, 11051,  7493,  9259,  5077, 13369, 10289,
	 4117, 15590, 18415, 12813, 18101,  2844, 13102,  6802,
	 4802,  4170, 17033,  7329, 15140,     4, 15470,  4728,
	11498, 11881,  5515, 15829,  7508, 13414,  8183,  2968,
	   81,  6857,  3577, 12887, 14773,  6257,  5635,  4141,
	 4355, 18215,  4803,   386,  2568, 15312, 12364, 16011,
	 9971,  2087,  7035, 15245,  6870, 12883,  9820,  2048,
	 9503,  3431,  6849,   182, 15728,  5405, 10032, 10892,
	 7427,  6557,  4606,  8514,  9175,  9572,  6246, 14675,
	12678,  7547, 17800, 17415, 12902,  7849,  6073,  5719,
	15262, 17614, 12210,  8891, 10155,  6285,  3327,   371,
	11109,  9217,  6542,   591, 18258, 17045, 14346, 18354,
	12065,  4581, 12121, 13873,   321,  1914, 10762, 13522,
	 8759, 16911, 12225,  7430, 16576,  3915, 16986,   847,
	11952,  8214,  7586, 13190,   648, 17990, 10183, 10931,
	 7690,  6747,  2111, 11898, 16407, 16689,  1558,  3088,
	 4854, 10165,  4765, 15147, 18252,  2883,  7254, 16034,
	 1550, 14927,  7233,  3333, 10522,    32, 13162,   958,
	18150,  1758, 15721, 13460, 11422,  4537,  7848, 17164,
	  259, 15326, 11210, 14126, 18336, 16821, 14377, 11648,
	13534, 12651, 15777,  4319, 14503, 14122, 18289, 10339,
	 4223,  1579, 14676,  4645,   340,  3750, 14787,  8580,
	10662,  4829, 12745, 12081,  5686, 13920, 11240, 11204,
	13430,   661,  3447,  7116,  8279,  8364, 16288,  6160,
	 5385, 10058,  5685, 17704,   403,  4987, 15521, 14507,
	 3474, 15546, 14142, 16104, 15068, 14390,  4098, 13754,
	12138,  4844,  6242, 11378,   436,  9146, 17661,  8834,
	 4719,  4881, 11092, 18246,  5919, 17032, 10151,  2988,
	10093,  1264,  3775,   975, 18425, 11839,  8977,  3051,
	13104, 17667,  5208, 16238, 10038,  6621, 12497, 10430,
	12967,  1518,  9171,  6275,  3257,  7189, 15710, 18218,
	10604,  3105, 17921,  1943,   797,  7164,  1971,  7101,
	11938,  5891,  9471, 13921,  2646, 15088, 12395,  9305,
	16040,  4509, 10156,  2501,  7088, 17456,  9434,  6465,
	 2304,   473, 13677,  6096,   347, 14128,  4628, 17431,
	 3037, 10184, 13732,   739, 11602,  5438, 17845, 13032,
	 9597, 16395,  7359,  5807, 12846, 16990, 13613,  8643,
	 8738,  4210,  5836, 17743,  1140, 17995,  1871, 16841
};

static const uint16_t iGMt_square[] = {
	 3318,   879,  6730, 10347,  8582,  5711,  3924, 12659,
	 5824,  9168,  7663, 16975, 17627, 10581,  5605,  1683,
	 4290,   170, 10006, 14232, 11376,  6767, 18361,  9407,
	11539, 11328, 16610, 16728,  7061,  3975, 17105,  9658,
	16564,  3793,  8995, 18059,  5949,  3845,   779, 18292,
	 8017,  9126, 14299, 13242,    16,  6102, 12833,  2528,
	 1544, 17420, 12590,  4323,  6595,  5976, 14308,  9762,
	10883,   775,  6581,  5245, 10658, 14043, 11599,  6561,
	 1176,  6105, 12359,  1478,  9512, 14771,  7173,  9823,
	 6761,  9377, 11507, 17557, 11174, 17286, 15329, 14357,
	12076,  6451, 12990,  9409,  4257, 12930,  3123,  9018,
	 1024,  3435, 10260, 14328, 11919, 18003, 12641,  3036,
	 9640,  8288, 17672, 11614, 16153, 15249,  5381,  8420,
	 9402, 14294,  8807, 10876, 17739, 16429,  3271,   946,
	 5446,  7864, 10932, 12550, 16839, 14202,  4910,  6210,
	17924,  6339, 12253, 11743,  4786,  5002,  2303,   435,
	12352, 10329,  8555, 16151, 15894, 10942,  3866,  4364,
	13332,  6200, 15782,  5094, 11532,  1746,   627, 15622,
	13357,  8822,  7032,  9044, 11985, 10916,  7974, 13464,
	17276, 17270, 17857,  1524,  6316,  3258,  1360,  2546,
	17222,  1284, 18324, 11425, 15660,  9257, 12034,  4258,
	 2364,  7570,  2085,  4852,  6707, 11824, 11974,  9025,
	 8192,  9047,  8348,  4026,  3187, 14993,  8963,  5855,
	15623, 11275,  6551, 16845, 11755,  1540, 14742, 13990,
	 4490,  2713, 13738,  8966, 15000,  6395,  3405, 10576,
	 1205,  1036,  2209,  6060, 18148, 18035,  7585, 10269,
	 6858,  2592, 14423, 14450, 11457, 12313,  8444,  3772,
	 5289,   983, 10583,  6177,  4409, 15600,  5222, 14601,
	 3401, 18267,  7795,  2801, 12963,  1416, 15901,  2091,
	  728,  1146,  3262,  4426, 14666, 12655,  9707, 13103,
	11287, 16603, 12645, 13778,  7656,  7393, 11618, 11503,
	17131,  5749, 13308, 15480,     2,  5371, 17733,   316
};

static const uint16_t iGMt_cubic[] = {
	    0,     0, 10467, 10693, 11779, 12521, 11471,  8020,
	12449,  4717,  8728,  3544, 12446, 11795,  6342,  4704,
	 8174,  8016,   350, 16007,  5349,  6531, 14648, 14649,
	13869, 15414,  7544,  1323, 16177, 13952, 12162,  5969,
	 3492,   759, 12354, 13802,  9109,  7855, 12811, 10845,
	12767, 10202,  3582,  9615, 10188, 18177, 10769,  5302,
	15342,  5520, 17791,  3186, 12624,  3504, 12736,  3465,
	12416,  8843,   915, 16304,  3714, 11544,  4588,  1694,
	 6287, 17725, 11062,  8327,  1266, 17663, 11510,  8171,
	 5941, 16858,    83,   794,  9221,  7816,  3579, 16693,
	16802,  1720,  5410, 16220,  4735,  5099, 17860,  6289,
	17226,  2889,  4693, 12026,  4363, 16420, 16924,  2665,
	17637, 10152, 18214,   570, 18088,  2918,  2105,  4369,
	13538, 16023,  8495,  6423, 12120, 12896, 17414, 14015,
	 6516, 18139,  2719,  5801,  9586,  6866,  5092, 10735,
	17932,  2314,  7064,  9390,  3048, 16055,  9453,  1152,
	14786,  2422,  5689,  3121,  4417, 18047,  4573,   218,
	 1494, 14292,  8516, 12176,  9123,  5546, 11657, 11576,
	 5215, 15465, 12527,  5019,  8119,  2604, 18050,  6552,
	10742, 13705, 15136, 18429,  9704, 11104,   632, 14263,
	 6300, 11631, 15257, 15589,  5602,  5620,  6960,  2843,
	 3080,  8144,  4182, 13356,  3558, 10940,  9547,  6715,
	 6877,  2049,  7195,  7534,  8052,  7071,  7773,  1737,
	16470, 16977, 11710,  9418,  8852, 12059,  5029, 11909,
	 8112, 12975,   194, 15403, 14446,  5832, 17915, 11701,
	 2737,   199, 14022,  4663,  5424, 13911,   566,  4082,
	  288,  2533,  7860, 17671,  5312, 13950,  9798, 16667,
	 7514, 16804,  9987, 13145, 17753,  6820,  6019, 17160,
	15317,  3060,  4052,   564, 14211,  1141,  3053, 16547,
	16500,  1496, 17137, 16251,  3261, 11208, 12962, 10957,
	 3925, 17560,   362,  6128,  8903,  2331,  8725, 10622,
	 3967, 10633, 15333,  8321, 15822, 15886, 12458,  1916,
	 3463,  1592,  1578,   438,  6526,   690,  4528, 14223,
	 4970,  9790, 14289,  1443,  1552, 12626, 11635,  2038,
	 4813,  5401,  6164, 12995, 12993, 17694, 11286,  8249,
	 5630,  1002,  4652,  4305,  7581, 12337,  1831, 17960,
	 2969, 11968,  8065,   977,  7655, 15932, 11531, 13924,
	 3090,  9128,  5991,  3345, 13983,  4512,  6047, 12542,
	13303, 11332, 12066, 11269, 15978, 16490,  7499, 15328,
	15925,   215, 14501, 11244,  2896, 12158, 11449, 16915,
	 2067,  8003,  3417, 11812,  7403,  2195, 13870,   766,
	 5926, 15382,  6586,  6594,  2800, 17458,  8829, 17169,
	 7163, 15445,  7320,  1401, 11279,   187, 18271, 13552,
	 8827,  9599,  9723,  9287, 13297,  7055,  7294, 13589,
	 8777,  4679,   678,  4043, 16471,  2329,  6361,  2887,
	 1014,  3926, 13849, 13446,  6414,   729, 13760,  8375,
	10128, 12273, 18348, 10069, 14764, 11317, 12769, 17772,
	   36,  7229, 10199,  4513,   664,  6352,  5833, 13604,
	 6207,  9853, 15023, 14683, 10031, 13788,  2644, 16854,
	 7950,  8094,   381,  4311, 11458, 14114,   883,  5782,
	 2729,  6785,  1515,  1612, 15517,  4307,  3366,  3107,
	 9117,  1269,  6885, 13896,  2261,  4973, 16392, 16675,
	12204, 17475, 10490, 18401,  3900, 15100,  5056,  3506,
	 9653,  2399, 15369, 15550,  8051,  3286, 13122,  8268,
	16903, 15345, 18151,  1744,  8646,  6535,   943, 11686,
	17685,  7502,  1091,   443, 12829,  5243,  3738, 10219,
	16139, 17586, 12661, 14518,  4795, 11003, 10281,  1522,
	15673,  4911, 16840, 16519, 16681,  4560,  7484, 13852,
	14425,    79,  1213,  1388,  5951, 17842,  1892,  9216,
	 2956, 18062,  3870, 12148,  3319,  9542, 16081,   819,
	  354, 12714,  5053, 10584,   385,  1018,  5131, 10886,
	10004,  3758, 18036,  8861, 14525,  9919,   870, 11876,
	17573,  7541, 10323, 13028,  6667, 18251,  6072, 15002,
	 7772, 16385, 12420,  5550, 10223,  3188,  7884, 16346
};

/*
 * Reduce a small signed integer modulo q. The source integer MUST
 * be between -q/2 and +q/2.
 */
static inline uint32_t
mq_conv_small(int x, uint32_t q)
{
	/*
	 * If x < 0, the cast to uint32_t will set the high bit to 1.
	 */
	uint32_t y;

	y = (uint32_t)x;
	y += q & -(y >> 31);
	return y;
}

/*
 * Addition modulo q. Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_add(uint32_t x, uint32_t y, uint32_t q)
{
	/*
	 * We compute x + y - q. If the result is negative, then the
	 * high bit will be set, and 'd >> 31' will be equal to 1;
	 * thus '-(d >> 31)' will be an all-one pattern. Otherwise,
	 * it will be an all-zero pattern. In other words, this
	 * implements a conditional addition of q.
	 */
	uint32_t d;

	d = x+ y;

	if(d>q)
		d -= q;

//	d = x + y - q;
//	d += q & -(d >> 31);
	return d;
}

/*
 * Subtraction modulo q. Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_sub(uint32_t x, uint32_t y, uint32_t q)
{
	/*
	 * As in mq_add(), we use a conditional addition to ensure the
	 * result is in the 0..q-1 range.
	 */
	uint32_t d;

//	d = x - y;
	if(x>y)
		d = x - y;
	else
		d = x - y + q;
//	d += q & -(d >> 31);
	return d;
}

/*
 * Division by 2 modulo q. Operand must be in the 0..q-1 range.
 */
static inline uint32_t
mq_rshift1(uint32_t x, uint32_t q)
{
	x += q & -(x & 1);
	return (x >> 1);
}

/*
 * Montgomery multiplication modulo q. If we set R = 2^16 mod q, then
 * this function computes: x * y / R mod q
 * Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_montymul(uint32_t x, uint32_t y, uint32_t q, uint32_t q0i)
{
	uint32_t z, w, temp;

	/*
	 * We compute x*y + k*q with a value of k chosen so that the 16
	 * low bits of the result are 0. We can then shift the value.
	 * After the shift, result may still be larger than q, but it
	 * will be lower than 2*q, so a conditional subtraction works.
	 */

//	z = (x * y) & 0xFFFFFFFF;
//	w = ((z * q0i) & 0xFFFF);
//	w = w * q;
//
//	/*
//	 * When adding z and w, the result will have its low 16 bits
//	 * equal to 0. Since x, y and z are lower than q, the sum will
//	 * be no more than (2^15 - 1) * q + (q - 1)^2, which will
//	 * fit on 29 bits.
//	 */
//	z = z + w;
	z = (x * y + ((x * y * q0i)& 0xFFFF)*q) >> 16;
//	z= ((x * y) >> 16) + ((((x * y * q0i)& 0xFFFF)*q) >> 16);
//	z = ((x * y) >> 16) + ((((x * y * q0i)& 0xFFFF)*q) >> 16) + ((((x * y) & 0xFFFF) + ((((x * y * q0i)& 0xFFFF)*q) & 0xFFFF))>>16);
//	z = z >> 16;
	/*
	 * After the shift, analysis shows that the value will be less
	 * than 2q. We do a subtraction then conditional subtraction to
	 * ensure the result is in the expected range.
	 */
	if(z > q)
		z -= q;

//	z -= q;
//	z += q & -(z >> 31);
	return z;
}
static inline uint16_t
mq_montymul16(uint32_t x, uint32_t y, uint32_t q, uint32_t q0i)
{
	uint32_t z, w;
	uint16_t temp;

	/*
	 * We compute x*y + k*q with a value of k chosen so that the 16
	 * low bits of the result are 0. We can then shift the value.
	 * After the shift, result may still be larger than q, but it
	 * will be lower than 2*q, so a conditional subtraction works.
	 */

//	z = (x * y) & 0xFFFFFFFF;
//	w = ((z * q0i) & 0xFFFF);
//	w = w * q;
//
//	/*
//	 * When adding z and w, the result will have its low 16 bits
//	 * equal to 0. Since x, y and z are lower than q, the sum will
//	 * be no more than (2^15 - 1) * q + (q - 1)^2, which will
//	 * fit on 29 bits.
//	 */
//	z = z + w;
	z = ((x * y) >> 16) + ((((x * y * q0i)& 0xFFFF)*q) >> 16) + ((((x * y) & 0xFFFF) + ((((x * y * q0i)& 0xFFFF)*q) & 0xFFFF))>>16);
//	z = (((x * y) + (((x * y * q0i)& 0xFFFF)*q)) >> 16);
	//z = z >> 16;

	/*
	 * After the shift, analysis shows that the value will be less
	 * than 2q. We do a subtraction then conditional subtraction to
	 * ensure the result is in the expected range.
	 */
	if(z > q)
		z -= q;
//	z -= q;
//	z += q & -(z >> 31);
	return z;
}

/*
 * Montgomery squaring (computes (x^2)/R).
 */
static inline uint32_t
mq_montysqr(uint32_t x, uint32_t q, uint32_t q0i)
{
	return mq_montymul(x, x, q, q0i);
}

/*
 * Divide x by y modulo q = 12289.
 */
static inline uint32_t
mq_div_12289(uint32_t x, uint32_t y)
{
	/*
	 * We invert y by computing y^(q-2) mod q.
	 *
	 * We use the following addition chain for exponent e = 12287:
	 *
	 *   e0 = 1
	 *   e1 = 2 * e0 = 2
	 *   e2 = e1 + e0 = 3
	 *   e3 = e2 + e1 = 5
	 *   e4 = 2 * e3 = 10
	 *   e5 = 2 * e4 = 20
	 *   e6 = 2 * e5 = 40
	 *   e7 = 2 * e6 = 80
	 *   e8 = 2 * e7 = 160
	 *   e9 = e8 + e2 = 163
	 *   e10 = e9 + e8 = 323
	 *   e11 = 2 * e10 = 646
	 *   e12 = 2 * e11 = 1292
	 *   e13 = e12 + e9 = 1455
	 *   e14 = 2 * e13 = 2910
	 *   e15 = 2 * e14 = 5820
	 *   e16 = e15 + e10 = 6143
	 *   e17 = 2 * e16 = 12286
	 *   e18 = e17 + e0 = 12287
	 *
	 * Additions on exponents are converted to Montgomery
	 * multiplications. We define all intermediate results as so
	 * many local variables, and let the C compiler work out which
	 * must be kept around.
	 */
	uint32_t y0, y1, y2, y3, y4, y5, y6, y7, y8, y9;
	uint32_t y10, y11, y12, y13, y14, y15, y16, y17, y18;

	y0 = mq_montymul(y, R2b, Qb, Q0Ib);
	y1 = mq_montysqr(y0, Qb, Q0Ib);
	y2 = mq_montymul(y1, y0, Qb, Q0Ib);
	y3 = mq_montymul(y2, y1, Qb, Q0Ib);
	y4 = mq_montysqr(y3, Qb, Q0Ib);
	y5 = mq_montysqr(y4, Qb, Q0Ib);
	y6 = mq_montysqr(y5, Qb, Q0Ib);
	y7 = mq_montysqr(y6, Qb, Q0Ib);
	y8 = mq_montysqr(y7, Qb, Q0Ib);
	y9 = mq_montymul(y8, y2, Qb, Q0Ib);
	y10 = mq_montymul(y9, y8, Qb, Q0Ib);
	y11 = mq_montysqr(y10, Qb, Q0Ib);
	y12 = mq_montysqr(y11, Qb, Q0Ib);
	y13 = mq_montymul(y12, y9, Qb, Q0Ib);
	y14 = mq_montysqr(y13, Qb, Q0Ib);
	y15 = mq_montysqr(y14, Qb, Q0Ib);
	y16 = mq_montymul(y15, y10, Qb, Q0Ib);
	y17 = mq_montysqr(y16, Qb, Q0Ib);
	y18 = mq_montymul(y17, y0, Qb, Q0Ib);

	/*
	 * Final multiplication with x, which is not in Montgomery
	 * representation, computes the correct division result.
	 */
	return mq_montymul(y18, x, Qb, Q0Ib);
}

/*
 * Divide x by y modulo q = 18433.
 */
static inline uint32_t
mq_div_18433(uint32_t x, uint32_t y)
{
	/*
	 * We invert y by computing y^(q-2) mod q.
	 *
	 * We use the following addition chain for exponent e = 18431:
	 *
	 *   e0             = 1
	 *   e1  = 2 * e0   = 2
	 *   e2  = e1 + e0  = 3
	 *   e3  = 2 * e2   = 6
	 *   e4  = e3 + e0  = 7
	 *   e5  = 2 * e4   = 14
	 *   e6  = 2 * e5   = 28
	 *   e7  = e6 + e4  = 35
	 *   e8  = e7 + e6  = 63
	 *   e9  = 2 * e8   = 126
	 *   e10 = 2 * e9   = 252
	 *   e11 = e10 + e7 = 287
	 *   e12 = 2 * e11  = 574
	 *   e13 = 2 * e12  = 1148
	 *   e14 = 2 * e13  = 2296
	 *   e15 = 2 * e14  = 4592
	 *   e16 = 2 * e15  = 9184
	 *   e17 = 2 * e16  = 18368
	 *   e18 = e17 + e8 = 18431
	 *
	 * Additions on exponents are converted to Montgomery
	 * multiplications. We define all intermediate results as so
	 * many local variables, and let the C compiler work out which
	 * must be kept around.
	 */
	uint32_t y0, y1, y2, y3, y4, y5, y6, y7, y8, y9;
	uint32_t y10, y11, y12, y13, y14, y15, y16, y17, y18;

	y0  = mq_montymul(y, R2t, Qt, Q0It);          
	y1  = mq_montysqr(y0, Qt, Q0It);
	y2  = mq_montymul(y1, y0, Qt, Q0It);
	y3  = mq_montysqr(y2, Qt, Q0It);
	y4  = mq_montymul(y3, y0, Qt, Q0It);
	y5  = mq_montysqr(y4, Qt, Q0It);
	y6  = mq_montysqr(y5, Qt, Q0It);
	y7  = mq_montymul(y6, y4, Qt, Q0It);
	y8  = mq_montymul(y7, y6, Qt, Q0It);
	y9  = mq_montysqr(y8, Qt, Q0It);
	y10 = mq_montysqr(y9, Qt, Q0It);
	y11 = mq_montymul(y10, y7, Qt, Q0It);
	y12 = mq_montysqr(y11, Qt, Q0It);
	y13 = mq_montysqr(y12, Qt, Q0It);
	y14 = mq_montysqr(y13, Qt, Q0It);
	y15 = mq_montysqr(y14, Qt, Q0It);
	y16 = mq_montysqr(y15, Qt, Q0It);
	y17 = mq_montysqr(y16, Qt, Q0It);
	y18 = mq_montymul(y17, y8, Qt, Q0It);

	/*
	 * Final multiplication with x, which is not in Montgomery
	 * representation, computes the correct division result.
	 */
	return mq_montymul(y18, x, Qt, Q0It);
}

/*
 * Compute NTT on a ring element, binary case.
 */
static void
mq_NTT_binary(uint16_t *a, unsigned logn)
{
	size_t n, t, m;

	n = (size_t)1 << logn;
	t = n;
	for (m = 1; m < n; m <<= 1) {
		size_t ht, i, j1;

		ht = t >> 1;
		for (i = 0, j1 = 0; i < m; i ++, j1 += t) {
			size_t j, j2;
			uint32_t s;

			s = GMb[m + i];
			j2 = j1 + ht;
			mq_NTT_binary_label4:for (j = j1; j < j2; j ++) {
				uint32_t u, v;

				u = a[j];
				v = mq_montymul(a[j + ht], s, Qb, Q0Ib);
				a[j] = (uint16_t)mq_add(u, v, Qb);
				a[j + ht] = (uint16_t)mq_sub(u, v, Qb);
			}
		}
		t = ht;
	}
}

/*
 * Compute the inverse NTT on a ring element, binary case.
 */
 void
mq_iNTT_binary(uint16_t a[1024], unsigned logn)
{
	size_t n, t, m;
	uint32_t ni;
	int loop2;
	uint32_t temp, temp3, temp4, temp5, temp6;
	uint16_t temp2;

	size_t hm, dt, i, j1;
	size_t j, j2;
	uint32_t s;
	uint16_t u, v, w;

	n = (size_t)1 << logn;
	t = 1;
	m = n;
	while (m > 1) {
		hm = m >> 1;
		dt = t << 1;
		for (i = 0, j1 = 0; i < hm; i ++, j1 += dt) {
			j2 = j1 + t;
			s = iGMb[hm + i];
			mq_iNTT_binary_label5:for (j = j1; j < j2; j ++) {
				u = a[j];
				v = a[j + t];
				a[j] = (uint16_t)mq_add(u, v, Qb);
				w = mq_sub(u, v, Qb);
				a[j + t] = (uint16_t)mq_montymul(w, s, Qb, Q0Ib);
			}
		}
		t = dt;
		m = hm;
	}
//	for(loop2=0;loop2<1024;loop2++)
//		printf("a[%d] = %d; ",loop2,a[loop2]);
//	printf("\n");
//	a[0] = 1579; a[1] = 3475; a[2] = 9900; a[3] = 11895; a[4] = 10110; a[5] = 12075; a[6] = 7394; a[7] = 7974; a[8] = 4924; a[9] = 9121; a[10] = 3467; a[11] = 5986; a[12] = 1982; a[13] = 78; a[14] = 3817; a[15] = 3168; a[16] = 11338; a[17] = 2167; a[18] = 12144; a[19] = 3772; a[20] = 2382; a[21] = 3493; a[22] = 6823; a[23] = 11249; a[24] = 3490; a[25] = 11043; a[26] = 10689; a[27] = 7253; a[28] = 12160; a[29] = 11758; a[30] = 4981; a[31] = 12112; a[32] = 10210; a[33] = 3084; a[34] = 4613; a[35] = 9313; a[36] = 4504; a[37] = 4083; a[38] = 6758; a[39] = 1681; a[40] = 11964; a[41] = 9647; a[42] = 4106; a[43] = 6001; a[44] = 11627; a[45] = 2148; a[46] = 3387; a[47] = 1024; a[48] = 8052; a[49] = 9540; a[50] = 10750; a[51] = 2421; a[52] = 3598; a[53] = 5201; a[54] = 1694; a[55] = 11948; a[56] = 7353; a[57] = 7429; a[58] = 7808; a[59] = 2724; a[60] = 5862; a[61] = 11556; a[62] = 5343; a[63] = 3371; a[64] = 4899; a[65] = 11556; a[66] = 573; a[67] = 1341; a[68] = 6192; a[69] = 8524; a[70] = 7951; a[71] = 10361; a[72] = 4061; a[73] = 12013; a[74] = 7039; a[75] = 2551; a[76] = 1135; a[77] = 2598; a[78] = 11; a[79] = 6710; a[80] = 10510; a[81] = 12215; a[82] = 8754; a[83] = 10529; a[84] = 6295; a[85] = 8093; a[86] = 8404; a[87] = 8776; a[88] = 3628; a[89] = 11991; a[90] = 7214; a[91] = 3424; a[92] = 11229; a[93] = 10833; a[94] = 338; a[95] = 19; a[96] = 12147; a[97] = 7946; a[98] = 2465; a[99] = 5274; a[100] = 3248; a[101] = 6155; a[102] = 2036; a[103] = 622; a[104] = 4581; a[105] = 10202; a[106] = 7437; a[107] = 3285; a[108] = 5763; a[109] = 8878; a[110] = 3799; a[111] = 10968; a[112] = 11270; a[113] = 8799; a[114] = 5197; a[115] = 6222; a[116] = 8696; a[117] = 1007; a[118] = 823; a[119] = 5597; a[120] = 9291; a[121] = 11352; a[122] = 4703; a[123] = 4235; a[124] = 8600; a[125] = 5052; a[126] = 7029; a[127] = 319; a[128] = 8188; a[129] = 1913; a[130] = 11345; a[131] = 2295; a[132] = 2679; a[133] = 3888; a[134] = 976; a[135] = 433; a[136] = 8970; a[137] = 3473; a[138] = 274; a[139] = 3548; a[140] = 11599; a[141] = 11945; a[142] = 5452; a[143] = 10676; a[144] = 7654; a[145] = 2725; a[146] = 5; a[147] = 9446; a[148] = 10696; a[149] = 10267; a[150] = 11594; a[151] = 1372; a[152] = 3395; a[153] = 1683; a[154] = 7976; a[155] = 10562; a[156] = 10792; a[157] = 11183; a[158] = 4973; a[159] = 2756; a[160] = 1883; a[161] = 1139; a[162] = 5699; a[163] = 4200; a[164] = 2054; a[165] = 8495; a[166] = 12256; a[167] = 5354; a[168] = 10175; a[169] = 2406; a[170] = 5530; a[171] = 11539; a[172] = 4078; a[173] = 7913; a[174] = 12281; a[175] = 9241; a[176] = 8495; a[177] = 1253; a[178] = 9065; a[179] = 1617; a[180] = 11179; a[181] = 12125; a[182] = 8774; a[183] = 11942; a[184] = 6923; a[185] = 18; a[186] = 1945; a[187] = 2162; a[188] = 590; a[189] = 5155; a[190] = 11266; a[191] = 6740; a[192] = 3357; a[193] = 7484; a[194] = 6163; a[195] = 2083; a[196] = 525; a[197] = 2270; a[198] = 1529; a[199] = 7909; a[200] = 6470; a[201] = 7833; a[202] = 6000; a[203] = 6968; a[204] = 6787; a[205] = 11473; a[206] = 3429; a[207] = 3240; a[208] = 1024; a[209] = 4115; a[210] = 9857; a[211] = 2387; a[212] = 4822; a[213] = 9069; a[214] = 8226; a[215] = 9987; a[216] = 10721; a[217] = 4149; a[218] = 438; a[219] = 7558; a[220] = 1752; a[221] = 9730; a[222] = 11447; a[223] = 4128; a[224] = 10208; a[225] = 3035; a[226] = 2781; a[227] = 548; a[228] = 11049; a[229] = 296; a[230] = 501; a[231] = 5230; a[232] = 11910; a[233] = 1871; a[234] = 12226; a[235] = 6144; a[236] = 7036; a[237] = 10132; a[238] = 8818; a[239] = 6200; a[240] = 10193; a[241] = 5247; a[242] = 7256; a[243] = 11891; a[244] = 10920; a[245] = 10793; a[246] = 6832; a[247] = 1174; a[248] = 6067; a[249] = 7223; a[250] = 3851; a[251] = 3012; a[252] = 8880; a[253] = 9820; a[254] = 9664; a[255] = 8732; a[256] = 196; a[257] = 7157; a[258] = 10973; a[259] = 1965; a[260] = 6643; a[261] = 6928; a[262] = 8838; a[263] = 8419; a[264] = 1932; a[265] = 9888; a[266] = 1647; a[267] = 3328; a[268] = 9719; a[269] = 6610; a[270] = 8041; a[271] = 8358; a[272] = 8336; a[273] = 12056; a[274] = 11605; a[275] = 6716; a[276] = 2476; a[277] = 5890; a[278] = 8417; a[279] = 3511; a[280] = 7873; a[281] = 9683; a[282] = 10745; a[283] = 6899; a[284] = 663; a[285] = 10988; a[286] = 3207; a[287] = 8827; a[288] = 2346; a[289] = 463; a[290] = 3356; a[291] = 6906; a[292] = 9803; a[293] = 5075; a[294] = 1474; a[295] = 2859; a[296] = 5888; a[297] = 7758; a[298] = 11432; a[299] = 560; a[300] = 3582; a[301] = 10106; a[302] = 9458; a[303] = 8172; a[304] = 5763; a[305] = 12023; a[306] = 2142; a[307] = 6079; a[308] = 9510; a[309] = 2301; a[310] = 2263; a[311] = 8396; a[312] = 7394; a[313] = 7269; a[314] = 1918; a[315] = 3931; a[316] = 1115; a[317] = 8093; a[318] = 6662; a[319] = 6411; a[320] = 11924; a[321] = 2396; a[322] = 1163; a[323] = 2591; a[324] = 7433; a[325] = 1570; a[326] = 4572; a[327] = 4738; a[328] = 6273; a[329] = 7087; a[330] = 2915; a[331] = 2867; a[332] = 3940; a[333] = 1610; a[334] = 7152; a[335] = 10931; a[336] = 8511; a[337] = 5821; a[338] = 2300; a[339] = 7106; a[340] = 6721; a[341] = 4864; a[342] = 5971; a[343] = 10459; a[344] = 3352; a[345] = 7488; a[346] = 10982; a[347] = 2753; a[348] = 2229; a[349] = 3512; a[350] = 10663; a[351] = 1344; a[352] = 12140; a[353] = 9719; a[354] = 5982; a[355] = 3858; a[356] = 4830; a[357] = 9879; a[358] = 10658; a[359] = 7098; a[360] = 10390; a[361] = 2750; a[362] = 362; a[363] = 2100; a[364] = 8840; a[365] = 3341; a[366] = 11161; a[367] = 9051; a[368] = 2898; a[369] = 3879; a[370] = 7634; a[371] = 4692; a[372] = 4633; a[373] = 802; a[374] = 3154; a[375] = 1028; a[376] = 9692; a[377] = 3042; a[378] = 3305; a[379] = 5600; a[380] = 11757; a[381] = 4705; a[382] = 10194; a[383] = 10204; a[384] = 3557; a[385] = 11078; a[386] = 9165; a[387] = 11445; a[388] = 10172; a[389] = 69; a[390] = 33; a[391] = 2524; a[392] = 3004; a[393] = 4706; a[394] = 120; a[395] = 8425; a[396] = 1728; a[397] = 1716; a[398] = 6792; a[399] = 288; a[400] = 1909; a[401] = 9693; a[402] = 5960; a[403] = 11226; a[404] = 510; a[405] = 10087; a[406] = 6737; a[407] = 6181; a[408] = 3380; a[409] = 6780; a[410] = 316; a[411] = 10735; a[412] = 1079; a[413] = 10486; a[414] = 10920; a[415] = 1077; a[416] = 9533; a[417] = 1297; a[418] = 8718; a[419] = 6479; a[420] = 6317; a[421] = 11991; a[422] = 10220; a[423] = 3761; a[424] = 3297; a[425] = 778; a[426] = 650; a[427] = 9672; a[428] = 10850; a[429] = 4732; a[430] = 8183; a[431] = 3801; a[432] = 5442; a[433] = 8574; a[434] = 7217; a[435] = 6164; a[436] = 4510; a[437] = 8751; a[438] = 11229; a[439] = 8573; a[440] = 11490; a[441] = 388; a[442] = 2557; a[443] = 10953; a[444] = 10828; a[445] = 3115; a[446] = 12125; a[447] = 6349; a[448] = 8712; a[449] = 2040; a[450] = 10784; a[451] = 175; a[452] = 3338; a[453] = 4635; a[454] = 815; a[455] = 5293; a[456] = 2903; a[457] = 6502; a[458] = 11118; a[459] = 957; a[460] = 3284; a[461] = 11526; a[462] = 10371; a[463] = 4735; a[464] = 8646; a[465] = 7716; a[466] = 7574; a[467] = 10613; a[468] = 1667; a[469] = 6944; a[470] = 5693; a[471] = 6891; a[472] = 5582; a[473] = 12098; a[474] = 9999; a[475] = 11100; a[476] = 10396; a[477] = 3778; a[478] = 11974; a[479] = 7760; a[480] = 7229; a[481] = 3285; a[482] = 3633; a[483] = 2524; a[484] = 7762; a[485] = 8628; a[486] = 2292; a[487] = 4672; a[488] = 7771; a[489] = 11342; a[490] = 4620; a[491] = 12045; a[492] = 10428; a[493] = 2352; a[494] = 6829; a[495] = 12182; a[496] = 5047; a[497] = 3577; a[498] = 11768; a[499] = 9531; a[500] = 10942; a[501] = 7574; a[502] = 4580; a[503] = 754; a[504] = 1140; a[505] = 11221; a[506] = 2482; a[507] = 706; a[508] = 11380; a[509] = 2713; a[510] = 10973; a[511] = 1489; a[512] = 0; a[513] = 0; a[514] = 0; a[515] = 0; a[516] = 0; a[517] = 0; a[518] = 0; a[519] = 0; a[520] = 0; a[521] = 0; a[522] = 0; a[523] = 0; a[524] = 0; a[525] = 0; a[526] = 0; a[527] = 0; a[528] = 0; a[529] = 0; a[530] = 0; a[531] = 0; a[532] = 0; a[533] = 0; a[534] = 0; a[535] = 0; a[536] = 0; a[537] = 0; a[538] = 0; a[539] = 0; a[540] = 0; a[541] = 0; a[542] = 0; a[543] = 0; a[544] = 0; a[545] = 0; a[546] = 0; a[547] = 0; a[548] = 0; a[549] = 0; a[550] = 0; a[551] = 0; a[552] = 0; a[553] = 0; a[554] = 0; a[555] = 0; a[556] = 0; a[557] = 0; a[558] = 0; a[559] = 0; a[560] = 0; a[561] = 0; a[562] = 0; a[563] = 0; a[564] = 0; a[565] = 0; a[566] = 0; a[567] = 0; a[568] = 0; a[569] = 0; a[570] = 0; a[571] = 0; a[572] = 0; a[573] = 0; a[574] = 0; a[575] = 0; a[576] = 0; a[577] = 0; a[578] = 0; a[579] = 0; a[580] = 0; a[581] = 0; a[582] = 0; a[583] = 0; a[584] = 0; a[585] = 0; a[586] = 0; a[587] = 0; a[588] = 0; a[589] = 0; a[590] = 0; a[591] = 0; a[592] = 0; a[593] = 0; a[594] = 0; a[595] = 0; a[596] = 0; a[597] = 0; a[598] = 0; a[599] = 0; a[600] = 0; a[601] = 0; a[602] = 0; a[603] = 0; a[604] = 0; a[605] = 0; a[606] = 0; a[607] = 0; a[608] = 0; a[609] = 0; a[610] = 0; a[611] = 0; a[612] = 0; a[613] = 0; a[614] = 0; a[615] = 0; a[616] = 0; a[617] = 0; a[618] = 0; a[619] = 0; a[620] = 0; a[621] = 0; a[622] = 0; a[623] = 0; a[624] = 0; a[625] = 0; a[626] = 0; a[627] = 0; a[628] = 0; a[629] = 0; a[630] = 0; a[631] = 0; a[632] = 0; a[633] = 0; a[634] = 0; a[635] = 0; a[636] = 0; a[637] = 0; a[638] = 0; a[639] = 0; a[640] = 0; a[641] = 0; a[642] = 0; a[643] = 0; a[644] = 0; a[645] = 0; a[646] = 0; a[647] = 0; a[648] = 0; a[649] = 0; a[650] = 0; a[651] = 0; a[652] = 0; a[653] = 0; a[654] = 0; a[655] = 0; a[656] = 0; a[657] = 0; a[658] = 0; a[659] = 0; a[660] = 0; a[661] = 0; a[662] = 0; a[663] = 0; a[664] = 0; a[665] = 0; a[666] = 0; a[667] = 0; a[668] = 0; a[669] = 0; a[670] = 0; a[671] = 0; a[672] = 0; a[673] = 0; a[674] = 0; a[675] = 0; a[676] = 0; a[677] = 0; a[678] = 0; a[679] = 0; a[680] = 0; a[681] = 0; a[682] = 0; a[683] = 0; a[684] = 0; a[685] = 0; a[686] = 0; a[687] = 0; a[688] = 0; a[689] = 0; a[690] = 0; a[691] = 0; a[692] = 0; a[693] = 0; a[694] = 0; a[695] = 0; a[696] = 0; a[697] = 0; a[698] = 0; a[699] = 0; a[700] = 0; a[701] = 0; a[702] = 0; a[703] = 0; a[704] = 0; a[705] = 0; a[706] = 0; a[707] = 0; a[708] = 0; a[709] = 0; a[710] = 0; a[711] = 0; a[712] = 0; a[713] = 0; a[714] = 0; a[715] = 0; a[716] = 0; a[717] = 0; a[718] = 0; a[719] = 0; a[720] = 0; a[721] = 0; a[722] = 0; a[723] = 0; a[724] = 0; a[725] = 0; a[726] = 0; a[727] = 0; a[728] = 0; a[729] = 0; a[730] = 0; a[731] = 0; a[732] = 0; a[733] = 0; a[734] = 0; a[735] = 0; a[736] = 0; a[737] = 0; a[738] = 0; a[739] = 0; a[740] = 0; a[741] = 0; a[742] = 0; a[743] = 0; a[744] = 0; a[745] = 0; a[746] = 0; a[747] = 0; a[748] = 0; a[749] = 0; a[750] = 0; a[751] = 0; a[752] = 0; a[753] = 0; a[754] = 0; a[755] = 0; a[756] = 0; a[757] = 0; a[758] = 0; a[759] = 0; a[760] = 0; a[761] = 0; a[762] = 0; a[763] = 0; a[764] = 0; a[765] = 0; a[766] = 0; a[767] = 0; a[768] = 0; a[769] = 0; a[770] = 0; a[771] = 0; a[772] = 0; a[773] = 0; a[774] = 0; a[775] = 0; a[776] = 0; a[777] = 0; a[778] = 0; a[779] = 0; a[780] = 0; a[781] = 0; a[782] = 0; a[783] = 0; a[784] = 0; a[785] = 0; a[786] = 0; a[787] = 0; a[788] = 0; a[789] = 0; a[790] = 0; a[791] = 0; a[792] = 0; a[793] = 0; a[794] = 0; a[795] = 0; a[796] = 0; a[797] = 0; a[798] = 0; a[799] = 0; a[800] = 0; a[801] = 0; a[802] = 0; a[803] = 0; a[804] = 0; a[805] = 0; a[806] = 0; a[807] = 0; a[808] = 0; a[809] = 0; a[810] = 0; a[811] = 0; a[812] = 0; a[813] = 0; a[814] = 0; a[815] = 0; a[816] = 0; a[817] = 0; a[818] = 0; a[819] = 0; a[820] = 0; a[821] = 0; a[822] = 0; a[823] = 0; a[824] = 0; a[825] = 0; a[826] = 0; a[827] = 0; a[828] = 0; a[829] = 0; a[830] = 0; a[831] = 0; a[832] = 0; a[833] = 0; a[834] = 0; a[835] = 0; a[836] = 0; a[837] = 0; a[838] = 0; a[839] = 0; a[840] = 0; a[841] = 0; a[842] = 0; a[843] = 0; a[844] = 0; a[845] = 0; a[846] = 0; a[847] = 0; a[848] = 0; a[849] = 0; a[850] = 0; a[851] = 0; a[852] = 0; a[853] = 0; a[854] = 0; a[855] = 0; a[856] = 0; a[857] = 0; a[858] = 0; a[859] = 0; a[860] = 0; a[861] = 0; a[862] = 0; a[863] = 0; a[864] = 0; a[865] = 0; a[866] = 0; a[867] = 0; a[868] = 0; a[869] = 0; a[870] = 0; a[871] = 0; a[872] = 0; a[873] = 0; a[874] = 0; a[875] = 0; a[876] = 0; a[877] = 0; a[878] = 0; a[879] = 0; a[880] = 0; a[881] = 0; a[882] = 0; a[883] = 0; a[884] = 0; a[885] = 0; a[886] = 0; a[887] = 0; a[888] = 0; a[889] = 0; a[890] = 0; a[891] = 0; a[892] = 0; a[893] = 0; a[894] = 0; a[895] = 0; a[896] = 0; a[897] = 0; a[898] = 0; a[899] = 0; a[900] = 0; a[901] = 0; a[902] = 0; a[903] = 0; a[904] = 0; a[905] = 0; a[906] = 0; a[907] = 0; a[908] = 0; a[909] = 0; a[910] = 0; a[911] = 0; a[912] = 0; a[913] = 0; a[914] = 0; a[915] = 0; a[916] = 0; a[917] = 0; a[918] = 0; a[919] = 0; a[920] = 0; a[921] = 0; a[922] = 0; a[923] = 0; a[924] = 0; a[925] = 0; a[926] = 0; a[927] = 0; a[928] = 0; a[929] = 0; a[930] = 0; a[931] = 0; a[932] = 0; a[933] = 0; a[934] = 0; a[935] = 0; a[936] = 0; a[937] = 0; a[938] = 0; a[939] = 0; a[940] = 0; a[941] = 0; a[942] = 0; a[943] = 0; a[944] = 0; a[945] = 0; a[946] = 0; a[947] = 0; a[948] = 0; a[949] = 0; a[950] = 0; a[951] = 0; a[952] = 0; a[953] = 0; a[954] = 0; a[955] = 0; a[956] = 0; a[957] = 0; a[958] = 0; a[959] = 0; a[960] = 0; a[961] = 0; a[962] = 0; a[963] = 0; a[964] = 0; a[965] = 0; a[966] = 0; a[967] = 0; a[968] = 0; a[969] = 0; a[970] = 0; a[971] = 0; a[972] = 0; a[973] = 0; a[974] = 0; a[975] = 0; a[976] = 0; a[977] = 0; a[978] = 0; a[979] = 0; a[980] = 0; a[981] = 0; a[982] = 0; a[983] = 0; a[984] = 0; a[985] = 0; a[986] = 0; a[987] = 0; a[988] = 0; a[989] = 0; a[990] = 0; a[991] = 0; a[992] = 0; a[993] = 0; a[994] = 0; a[995] = 0; a[996] = 0; a[997] = 0; a[998] = 0; a[999] = 0; a[1000] = 0; a[1001] = 0; a[1002] = 0; a[1003] = 0; a[1004] = 0; a[1005] = 0; a[1006] = 0; a[1007] = 0; a[1008] = 0; a[1009] = 0; a[1010] = 0; a[1011] = 0; a[1012] = 0; a[1013] = 0; a[1014] = 0; a[1015] = 0; a[1016] = 0; a[1017] = 0; a[1018] = 0; a[1019] = 0; a[1020] = 0; a[1021] = 0; a[1022] = 0; a[1023] = 0;
	/*
	 * To complete the inverse NTT, we must now divide all values by
	 * n (the vector size). We thus need the inverse of n, i.e. we
	 * need to divide 1 by 2 logn times. But we also want it in
	 * Montgomery representation, i.e. we also want to multiply it
	 * by R = 2^16. In the common case, this should be a simple right
	 * shift. The loop below is generic and works also in corner cases;
	 * its computation time is negligible.
	 */
	ni = Rb;
	for (m = n; m > 1; m >>= 1) {
		ni = mq_rshift1(ni, Qb);
	}
//	printf("ni = %d\n",ni);
//	ni = 128;
	for (m = 0; m < 512; m ++) {
//		a[m] = ((uint32_t)((a[m] * ni * Q0Ib)& 0xFFFF)*Qb + (uint32_t)(a[m] * ni)) >> 16;
//		a[m] = ((a[m] * ni) + (((a[m] * ni * Q0Ib) & 0xFFFF) * Qb)) % 65536;// >> 16;
//		temp = a[m] *ni;
//		temp2 = temp*Q0Ib;
//		//temp3 = temp2 % 65536;//& 0xFFFF;
//		temp4 = temp2 * Qb;
//		temp5 = temp4 % 65536;
//		temp6 = temp % 65536;
//		a[m] = (temp4 >> 16) + (temp >> 16) + ((temp5+ temp6) >> 16);
//		a[m] = (((temp4 /*+ (temp & 0xFFFF)*/) & 0xFFFFFFFF) >> 16);// + ((temp6+ temp7) >> 16);

//		//z = z >> 16;
//
//		/*
//		 * After the shift, analysis shows that the value will be less
//		 * than 2q. We do a subtraction then conditional subtraction to
//		 * ensure the result is in the expected range.
//		 */
//		if(a[m] > Qb)
//			a[m] -= Qb;
		a[m] = mq_montymul16(a[m], ni, Qb, Q0Ib);
	}
//		for(loop2=0;loop2<1024;loop2++)
//			printf("a[%d] = %d;\n ",loop2,a[loop2]);
//		printf("\n");
//		a[0] = 11260; a[1] = 2623; a[2] = 8180; a[3] = 9456; a[4] = 3140; a[5] = 5136; a[6] = 6879; a[7] = 5248; a[8] = 4714; a[9] = 2298; a[10] = 2815; a[11] = 3804; a[12] = 1588; a[13] = 10417; a[14] = 6704; a[15] = 9991; a[16] = 10535; a[17] = 9437; a[18] = 3480; a[19] = 7784; a[20] = 4277; a[21] = 2191; a[22] = 8294; a[23] = 382; a[24] = 2263; a[25] = 5326; a[26] = 1533; a[27] = 10263; a[28] = 3096; a[29] = 455; a[30] = 3346; a[31] = 4248; a[32] = 740; a[33] = 12007; a[34] = 12178; a[35] = 9979; a[36] = 2505; a[37] = 320; a[38] = 9854; a[39] = 8812; a[40] = 7800; a[41] = 1963; a[42] = 12057; a[43] = 3444; a[44] = 3599; a[45] = 9893; a[46] = 4735; a[47] = 2; a[48] = 3376; a[49] = 4531; a[50] = 69; a[51] = 3341; a[52] = 11960; a[53] = 10355; a[54] = 8500; a[55] = 8184; a[56] = 7863; a[57] = 6039; a[58] = 9232; a[59] = 8358; a[60] = 6780; a[61] = 5303; a[62] = 6947; a[63] = 5119; a[64] = 5314; a[65] = 5303; a[66] = 10826; a[67] = 4683; a[68] = 11149; a[69] = 4337; a[70] = 5800; a[71] = 9405; a[72] = 848; a[73] = 6624; a[74] = 3110; a[75] = 221; a[76] = 9627; a[77] = 11382; a[78] = 12025; a[79] = 11006; a[80] = 5829; a[81] = 1776; a[82] = 11106; a[83] = 5373; a[84] = 8677; a[85] = 2392; a[86] = 7217; a[87] = 10578; a[88] = 11240; a[89] = 7152; a[90] = 11199; a[91] = 3847; a[92] = 862; a[93] = 10366; a[94] = 4177; a[95] = 11833; a[96] = 3408; a[97] = 5920; a[98] = 2285; a[99] = 8603; a[100] = 8071; a[101] = 12037; a[102] = 292; a[103] = 9650; a[104] = 657; a[105] = 932; a[106] = 5847; a[107] = 7183; a[108] = 9156; a[109] = 8130; a[110] = 7136; a[111] = 7126; a[112] = 12167; a[113] = 10026; a[114] = 10451; a[115] = 10429; a[116] = 209; a[117] = 410; a[118] = 4826; a[119] = 851; a[120] = 10507; a[121] = 10199; a[122] = 10018; a[123] = 8961; a[124] = 2513; a[125] = 1642; a[126] = 3350; a[127] = 4633; a[128] = 112; a[129] = 3244; a[130] = 10367; a[131] = 6365; a[132] = 9438; a[133] = 5000; a[134] = 1154; a[135] = 1897; a[136] = 5922; a[137] = 2671; a[138] = 5713; a[139] = 871; a[140] = 4271; a[141] = 8256; a[142] = 4331; a[143] = 1845; a[144] = 639; a[145] = 8334; a[146] = 12169; a[147] = 6787; a[148] = 1365; a[149] = 11661; a[150] = 4391; a[151] = 3939; a[152] = 4543; a[153] = 8764; a[154] = 5200; a[155] = 4581; a[156] = 11350; a[157] = 1966; a[158] = 3538; a[159] = 7590; a[160] = 3964; a[161] = 9531; a[162] = 10692; a[163] = 9801; a[164] = 12149; a[165] = 5033; a[166] = 792; a[167] = 6683; a[168] = 1580; a[169] = 3701; a[170] = 2459; a[171] = 5711; a[172] = 440; a[173] = 6712; a[174] = 192; a[175] = 11707; a[176] = 5033; a[177] = 6795; a[178] = 3642; a[179] = 10348; a[180] = 2062; a[181] = 3936; a[182] = 10626; a[183] = 8328; a[184] = 5894; a[185] = 11857; a[186] = 2476; a[187] = 9557; a[188] = 10418; a[189] = 11459; a[190] = 12263; a[191] = 10286; a[192] = 5455; a[193] = 4719; a[194] = 11845; a[195] = 11453; a[196] = 11978; a[197] = 6965; a[198] = 171; a[199] = 6808; a[200] = 4477; a[201] = 8632; a[202] = 3468; a[203] = 4814; a[204] = 9158; a[205] = 7295; a[206] = 3727; a[207] = 8263; a[208] = 2; a[209] = 11841; a[210] = 9212; a[211] = 4157; a[212] = 7162; a[213] = 3546; a[214] = 11489; a[215] = 6092; a[216] = 765; a[217] = 11025; a[218] = 1777; a[219] = 2943; a[220] = 7108; a[221] = 12260; a[222] = 7919; a[223] = 11529; a[224] = 788; a[225] = 894; a[226] = 6990; a[227] = 11426; a[228] = 5182; a[229] = 5185; a[230] = 265; a[231] = 9659; a[232] = 9096; a[233] = 4252; a[234] = 1512; a[235] = 12; a[236] = 3182; a[237] = 2612; a[238] = 9570; a[239] = 10957; a[240] = 1148; a[241] = 9251; a[242] = 10191; a[243] = 9552; a[244] = 8278; a[245] = 11326; a[246] = 8078; a[247] = 8691; a[248] = 1860; a[249] = 10983; a[250] = 5888; a[251] = 1446; a[252] = 8082; a[253] = 10100; a[254] = 1555; a[255] = 11634; a[256] = 7585; a[257] = 278; a[258] = 7006; a[259] = 1996; a[260] = 325; a[261] = 5774; a[262] = 9090; a[263] = 6857; a[264] = 2788; a[265] = 8468; a[266] = 9628; a[267] = 6151; a[268] = 235; a[269] = 1117; a[270] = 3640; a[271] = 8321; a[272] = 8849; a[273] = 5592; a[274] = 4127; a[275] = 10862; a[276] = 2021; a[277] = 6108; a[278] = 6905; a[279] = 1759; a[280] = 7672; a[281] = 1099; a[282] = 189; a[283] = 6470; a[284] = 8666; a[285] = 6646; a[286] = 9055; a[287] = 9354; a[288] = 5141; a[289] = 1177; a[290] = 5479; a[291] = 6302; a[292] = 10508; a[293] = 1090; a[294] = 1491; a[295] = 5118; a[296] = 6156; a[297] = 10432; a[298] = 8279; a[299] = 11138; a[300] = 55; a[301] = 3236; a[302] = 6499; a[303] = 496; a[304] = 9156; a[305] = 6384; a[306] = 10037; a[307] = 1572; a[308] = 5251; a[309] = 6221; a[310] = 7133; a[311] = 7409; a[312] = 6879; a[313] = 9879; a[314] = 3124; a[315] = 3968; a[316] = 10107; a[317] = 2392; a[318] = 12158; a[319] = 5893; a[320] = 8760; a[321] = 3941; a[322] = 8955; a[323] = 11550; a[324] = 5943; a[325] = 11476; a[326] = 873; a[327] = 9178; a[328] = 9205; a[329] = 1958; a[330] = 3774; a[331] = 4926; a[332] = 3752; a[333] = 10516; a[334] = 398; a[335] = 8014; a[336] = 4649; a[337] = 7764; a[338] = 6245; a[339] = 1502; a[340] = 10742; a[341] = 6154; a[342] = 4164; a[343] = 7053; a[344] = 5575; a[345] = 4623; a[346] = 6790; a[347] = 7662; a[348] = 7949; a[349] = 1735; a[350] = 2157; a[351] = 4611; a[352] = 3576; a[353] = 235; a[354] = 3900; a[355] = 5720; a[356] = 6970; a[357] = 8684; a[358] = 2277; a[359] = 1694; a[360] = 8709; a[361] = 7734; a[362] = 3601; a[363] = 11045; a[364] = 9042; a[365] = 5839; a[366] = 2494; a[367] = 3978; a[368] = 4182; a[369] = 5216; a[370] = 1119; a[371] = 10282; a[372] = 11698; a[373] = 5330; a[374] = 10327; a[375] = 12195; a[376] = 883; a[377] = 726; a[378] = 6703; a[379] = 779; a[380] = 479; a[381] = 9970; a[382] = 1124; a[383] = 884; a[384] = 655; a[385] = 4486; a[386] = 1242; a[387] = 7967; a[388] = 1652; a[389] = 10633; a[390] = 11497; a[391] = 869; a[392] = 1638; a[393] = 9946; a[394] = 9409; a[395] = 6713; a[396] = 7684; a[397] = 7972; a[398] = 9038; a[399] = 5377; a[400] = 3340; a[401] = 859; a[402] = 4428; a[403] = 934; a[404] = 49; a[405] = 3692; a[406] = 10358; a[407] = 11413; a[408] = 4903; a[409] = 9326; a[410] = 4705; a[411] = 429; a[412] = 10971; a[413] = 6405; a[414] = 8278; a[415] = 11019; a[416] = 4699; a[417] = 5739; a[418] = 11970; a[419] = 4261; a[420] = 8149; a[421] = 7152; a[422] = 500; a[423] = 8048; a[424] = 6895; a[425] = 5906; a[426] = 8978; a[427] = 1363; a[428] = 9958; a[429] = 9322; a[430] = 232; a[431] = 7088; a[432] = 4571; a[433] = 3137; a[434] = 11127; a[435] = 11821; a[436] = 2361; a[437] = 11178; a[438] = 862; a[439] = 3161; a[440] = 6887; a[441] = 2977; a[442] = 77; a[443] = 7486; a[444] = 10486; a[445] = 11263; a[446] = 3936; a[447] = 7381; a[448] = 12114; a[449] = 196; a[450] = 11542; a[451] = 8089; a[452] = 5911; a[453] = 11650; a[454] = 5018; a[455] = 8147; a[456] = 4062; a[457] = 3709; a[458] = 3526; a[459] = 1610; a[460] = 7207; a[461] = 6023; a[462] = 9165; a[463] = 9250; a[464] = 1409; a[465] = 11440; a[466] = 2559; a[467] = 3357; a[468] = 9148; a[469] = 5390; a[470] = 10836; a[471] = 6662; a[472] = 1211; a[473] = 4584; a[474] = 5804; a[475] = 3958; a[476] = 8565; a[477] = 7640; a[478] = 7560; a[479] = 10384; a[480] = 10839; a[481] = 7183; a[482] = 11120; a[483] = 869; a[484] = 10336; a[485] = 1841; a[486] = 6437; a[487] = 10762; a[488] = 10120; a[489] = 10439; a[490] = 12010; a[491] = 5856; a[492] = 7797; a[493] = 4997; a[494] = 8150; a[495] = 2568; a[496] = 1762; a[497] = 175; a[498] = 215; a[499] = 4747; a[500] = 7750; a[501] = 2559; a[502] = 681; a[503] = 6482; a[504] = 9507; a[505] = 1054; a[506] = 1877; a[507] = 7634; a[508] = 9527; a[509] = 8622; a[510] = 7006; a[511] = 1131; a[512] = 0; a[513] = 0; a[514] = 0; a[515] = 0; a[516] = 0; a[517] = 0; a[518] = 0; a[519] = 0; a[520] = 0; a[521] = 0; a[522] = 0; a[523] = 0; a[524] = 0; a[525] = 0; a[526] = 0; a[527] = 0; a[528] = 0; a[529] = 0; a[530] = 0; a[531] = 0; a[532] = 0; a[533] = 0; a[534] = 0; a[535] = 0; a[536] = 0; a[537] = 0; a[538] = 0; a[539] = 0; a[540] = 0; a[541] = 0; a[542] = 0; a[543] = 0; a[544] = 0; a[545] = 0; a[546] = 0; a[547] = 0; a[548] = 0; a[549] = 0; a[550] = 0; a[551] = 0; a[552] = 0; a[553] = 0; a[554] = 0; a[555] = 0; a[556] = 0; a[557] = 0; a[558] = 0; a[559] = 0; a[560] = 0; a[561] = 0; a[562] = 0; a[563] = 0; a[564] = 0; a[565] = 0; a[566] = 0; a[567] = 0; a[568] = 0; a[569] = 0; a[570] = 0; a[571] = 0; a[572] = 0; a[573] = 0; a[574] = 0; a[575] = 0; a[576] = 0; a[577] = 0; a[578] = 0; a[579] = 0; a[580] = 0; a[581] = 0; a[582] = 0; a[583] = 0; a[584] = 0; a[585] = 0; a[586] = 0; a[587] = 0; a[588] = 0; a[589] = 0; a[590] = 0; a[591] = 0; a[592] = 0; a[593] = 0; a[594] = 0; a[595] = 0; a[596] = 0; a[597] = 0; a[598] = 0; a[599] = 0; a[600] = 0; a[601] = 0; a[602] = 0; a[603] = 0; a[604] = 0; a[605] = 0; a[606] = 0; a[607] = 0; a[608] = 0; a[609] = 0; a[610] = 0; a[611] = 0; a[612] = 0; a[613] = 0; a[614] = 0; a[615] = 0; a[616] = 0; a[617] = 0; a[618] = 0; a[619] = 0; a[620] = 0; a[621] = 0; a[622] = 0; a[623] = 0; a[624] = 0; a[625] = 0; a[626] = 0; a[627] = 0; a[628] = 0; a[629] = 0; a[630] = 0; a[631] = 0; a[632] = 0; a[633] = 0; a[634] = 0; a[635] = 0; a[636] = 0; a[637] = 0; a[638] = 0; a[639] = 0; a[640] = 0; a[641] = 0; a[642] = 0; a[643] = 0; a[644] = 0; a[645] = 0; a[646] = 0; a[647] = 0; a[648] = 0; a[649] = 0; a[650] = 0; a[651] = 0; a[652] = 0; a[653] = 0; a[654] = 0; a[655] = 0; a[656] = 0; a[657] = 0; a[658] = 0; a[659] = 0; a[660] = 0; a[661] = 0; a[662] = 0; a[663] = 0; a[664] = 0; a[665] = 0; a[666] = 0; a[667] = 0; a[668] = 0; a[669] = 0; a[670] = 0; a[671] = 0; a[672] = 0; a[673] = 0; a[674] = 0; a[675] = 0; a[676] = 0; a[677] = 0; a[678] = 0; a[679] = 0; a[680] = 0; a[681] = 0; a[682] = 0; a[683] = 0; a[684] = 0; a[685] = 0; a[686] = 0; a[687] = 0; a[688] = 0; a[689] = 0; a[690] = 0; a[691] = 0; a[692] = 0; a[693] = 0; a[694] = 0; a[695] = 0; a[696] = 0; a[697] = 0; a[698] = 0; a[699] = 0; a[700] = 0; a[701] = 0; a[702] = 0; a[703] = 0; a[704] = 0; a[705] = 0; a[706] = 0; a[707] = 0; a[708] = 0; a[709] = 0; a[710] = 0; a[711] = 0; a[712] = 0; a[713] = 0; a[714] = 0; a[715] = 0; a[716] = 0; a[717] = 0; a[718] = 0; a[719] = 0; a[720] = 0; a[721] = 0; a[722] = 0; a[723] = 0; a[724] = 0; a[725] = 0; a[726] = 0; a[727] = 0; a[728] = 0; a[729] = 0; a[730] = 0; a[731] = 0; a[732] = 0; a[733] = 0; a[734] = 0; a[735] = 0; a[736] = 0; a[737] = 0; a[738] = 0; a[739] = 0; a[740] = 0; a[741] = 0; a[742] = 0; a[743] = 0; a[744] = 0; a[745] = 0; a[746] = 0; a[747] = 0; a[748] = 0; a[749] = 0; a[750] = 0; a[751] = 0; a[752] = 0; a[753] = 0; a[754] = 0; a[755] = 0; a[756] = 0; a[757] = 0; a[758] = 0; a[759] = 0; a[760] = 0; a[761] = 0; a[762] = 0; a[763] = 0; a[764] = 0; a[765] = 0; a[766] = 0; a[767] = 0; a[768] = 0; a[769] = 0; a[770] = 0; a[771] = 0; a[772] = 0; a[773] = 0; a[774] = 0; a[775] = 0; a[776] = 0; a[777] = 0; a[778] = 0; a[779] = 0; a[780] = 0; a[781] = 0; a[782] = 0; a[783] = 0; a[784] = 0; a[785] = 0; a[786] = 0; a[787] = 0; a[788] = 0; a[789] = 0; a[790] = 0; a[791] = 0; a[792] = 0; a[793] = 0; a[794] = 0; a[795] = 0; a[796] = 0; a[797] = 0; a[798] = 0; a[799] = 0; a[800] = 0; a[801] = 0; a[802] = 0; a[803] = 0; a[804] = 0; a[805] = 0; a[806] = 0; a[807] = 0; a[808] = 0; a[809] = 0; a[810] = 0; a[811] = 0; a[812] = 0; a[813] = 0; a[814] = 0; a[815] = 0; a[816] = 0; a[817] = 0; a[818] = 0; a[819] = 0; a[820] = 0; a[821] = 0; a[822] = 0; a[823] = 0; a[824] = 0; a[825] = 0; a[826] = 0; a[827] = 0; a[828] = 0; a[829] = 0; a[830] = 0; a[831] = 0; a[832] = 0; a[833] = 0; a[834] = 0; a[835] = 0; a[836] = 0; a[837] = 0; a[838] = 0; a[839] = 0; a[840] = 0; a[841] = 0; a[842] = 0; a[843] = 0; a[844] = 0; a[845] = 0; a[846] = 0; a[847] = 0; a[848] = 0; a[849] = 0; a[850] = 0; a[851] = 0; a[852] = 0; a[853] = 0; a[854] = 0; a[855] = 0; a[856] = 0; a[857] = 0; a[858] = 0; a[859] = 0; a[860] = 0; a[861] = 0; a[862] = 0; a[863] = 0; a[864] = 0; a[865] = 0; a[866] = 0; a[867] = 0; a[868] = 0; a[869] = 0; a[870] = 0; a[871] = 0; a[872] = 0; a[873] = 0; a[874] = 0; a[875] = 0; a[876] = 0; a[877] = 0; a[878] = 0; a[879] = 0; a[880] = 0; a[881] = 0; a[882] = 0; a[883] = 0; a[884] = 0; a[885] = 0; a[886] = 0; a[887] = 0; a[888] = 0; a[889] = 0; a[890] = 0; a[891] = 0; a[892] = 0; a[893] = 0; a[894] = 0; a[895] = 0; a[896] = 0; a[897] = 0; a[898] = 0; a[899] = 0; a[900] = 0; a[901] = 0; a[902] = 0; a[903] = 0; a[904] = 0; a[905] = 0; a[906] = 0; a[907] = 0; a[908] = 0; a[909] = 0; a[910] = 0; a[911] = 0; a[912] = 0; a[913] = 0; a[914] = 0; a[915] = 0; a[916] = 0; a[917] = 0; a[918] = 0; a[919] = 0; a[920] = 0; a[921] = 0; a[922] = 0; a[923] = 0; a[924] = 0; a[925] = 0; a[926] = 0; a[927] = 0; a[928] = 0; a[929] = 0; a[930] = 0; a[931] = 0; a[932] = 0; a[933] = 0; a[934] = 0; a[935] = 0; a[936] = 0; a[937] = 0; a[938] = 0; a[939] = 0; a[940] = 0; a[941] = 0; a[942] = 0; a[943] = 0; a[944] = 0; a[945] = 0; a[946] = 0; a[947] = 0; a[948] = 0; a[949] = 0; a[950] = 0; a[951] = 0; a[952] = 0; a[953] = 0; a[954] = 0; a[955] = 0; a[956] = 0; a[957] = 0; a[958] = 0; a[959] = 0; a[960] = 0; a[961] = 0; a[962] = 0; a[963] = 0; a[964] = 0; a[965] = 0; a[966] = 0; a[967] = 0; a[968] = 0; a[969] = 0; a[970] = 0; a[971] = 0; a[972] = 0; a[973] = 0; a[974] = 0; a[975] = 0; a[976] = 0; a[977] = 0; a[978] = 0; a[979] = 0; a[980] = 0; a[981] = 0; a[982] = 0; a[983] = 0; a[984] = 0; a[985] = 0; a[986] = 0; a[987] = 0; a[988] = 0; a[989] = 0; a[990] = 0; a[991] = 0; a[992] = 0; a[993] = 0; a[994] = 0; a[995] = 0; a[996] = 0; a[997] = 0; a[998] = 0; a[999] = 0; a[1000] = 0; a[1001] = 0; a[1002] = 0; a[1003] = 0; a[1004] = 0; a[1005] = 0; a[1006] = 0; a[1007] = 0; a[1008] = 0; a[1009] = 0; a[1010] = 0; a[1011] = 0; a[1012] = 0; a[1013] = 0; a[1014] = 0; a[1015] = 0; a[1016] = 0; a[1017] = 0; a[1018] = 0; a[1019] = 0; a[1020] = 0; a[1021] = 0; a[1022] = 0; a[1023] = 0;

}

/*
 * Compute NTT on a ring element, ternary case.
 */
//static void
//mq_NTT_ternary(uint16_t *a, unsigned logn)
//{
//	size_t n, hn, u, v, t, m;
//	uint32_t r, w;
//
//	n = (size_t)3 << (logn - 1);
//	hn = n >> 1;
//
//	/*
//	 * Modulo X^2-X+1.
//	 */
//	r = GMt_square[1];
//	for (u = 0; u < hn; u ++) {
//		uint32_t a0, a1, b;
//
//		a0 = a[u];
//		a1 = a[u + hn];
//		b = mq_montymul(a1, r, Qt, Q0It);
//		a[u] = mq_add(a0, b, Qt);
//		a[u + hn] = mq_sub(mq_add(a0, a1, Qt), b, Qt);
//	}
//
//	/*
//	 * Intermediate steps for degree doubling.
//	 */
//	t = hn;
//	for (m = 2; t > 3; m <<= 1) {
//		size_t ht, u1, v1;
//
//		ht = t >> 1;
//		for (u1 = 0, v1 = 0; u1 < m; u1 ++, v1 += t) {
//			size_t v2;
//			uint32_t s;
//
//			s = GMt_square[m + u1];
//			v2 = v1 + ht;
//			for (v = v1; v < v2; v ++) {
//				uint32_t a0, a1;
//
//				a0 = a[v];
//				a1 = a[v + ht];
//				a1 = mq_montymul(a1, s, Qt, Q0It);
//				a[v] = mq_add(a0, a1, Qt);
//				a[v + ht] = mq_sub(a0, a1, Qt);
//			}
//		}
//		t = ht;
//	}
//
//	/*
//	 * Degree tripling.
//	 */
//	w = mq_montymul(GMt_square[1], GMt_square[1], Qt, Q0It);
//	for (u = 0, v = (size_t)1 << (logn - 1); u < n; u += 3, v ++) {
//		uint32_t fA, fB, fC, x, x2;
//		uint32_t fB0, fB1, fB2, fC0, fC1, fC2;
//
//		fA = a[u + 0];
//		fB = a[u + 1];
//		fC = a[u + 2];
//		x = GMt_cubic[v];
//		x2 = mq_montysqr(x, Qt, Q0It);
//		fB0 = mq_montymul(fB, x, Qt, Q0It);
//		fB1 = mq_montymul(fB0, w, Qt, Q0It);
//		fB2 = mq_montymul(fB1, w, Qt, Q0It);
//		fC0 = mq_montymul(fC, x2, Qt, Q0It);
//		fC1 = mq_montymul(fC0, w, Qt, Q0It);
//		fC2 = mq_montymul(fC1, w, Qt, Q0It);
//		a[u + 0] = mq_add(fA, mq_add(fB0, fC0, Qt), Qt);
//		a[u + 1] = mq_add(fA, mq_add(fB1, fC2, Qt), Qt);
//		a[u + 2] = mq_add(fA, mq_add(fB2, fC1, Qt), Qt);
//	}
//}
//
///*
// * Compute the inverse NTT on a ring element, ternary case.
// */
//static void
//mq_iNTT_ternary(uint16_t *a, unsigned logn)
//{
//	size_t n, hn, u, v, t, m;
//	uint32_t r, w, ni;
//
//	n = (size_t)3 << (logn - 1);
//	hn = n >> 1;
//
//	/*
//	 * Dividing degree by 3.
//	 */
//	w = mq_montymul(iGMt_square[1], iGMt_square[1], Qt, Q0It);
//	for (u = 0, v = (size_t)1 << (logn - 1); u < n; u += 3, v ++) {
//		uint32_t f0, f1, f2, x, x2;
//		uint32_t f11, f12, f21, f22;
//
//		f0 = a[u + 0];
//		f1 = a[u + 1];
//		f2 = a[u + 2];
//		x = iGMt_cubic[v];
//		x2 = mq_montysqr(x, Qt, Q0It);
//		f11 = mq_montymul(f1, w, Qt, Q0It);
//		f12 = mq_montymul(f11, w, Qt, Q0It);
//		f21 = mq_montymul(f2, w, Qt, Q0It);
//		f22 = mq_montymul(f21, w, Qt, Q0It);
//		a[u + 0] = mq_add(f0, mq_add(f1, f2, Qt), Qt);
//		a[u + 1] = mq_montymul(x,
//			mq_add(f0, mq_add(f11, f22, Qt), Qt), Qt, Q0It);
//		a[u + 2] = mq_montymul(x2,
//			mq_add(f0, mq_add(f12, f21, Qt), Qt), Qt, Q0It);
//	}
//
//	/*
//	 * Intermediate steps for degree halving.
//	 */
//	t = 6;
//	for (m = (size_t)1 << (logn - 2); t < n; m >>= 1) {
//		size_t ht, u1, v1;
//
//		ht = t >> 1;
//		for (u1 = 0, v1 = 0; u1 < m; u1 ++, v1 += t) {
//			size_t v2;
//			uint32_t s;
//
//			s = iGMt_square[m + u1];
//			v2 = v1 + ht;
//			for (v = v1; v < v2; v ++) {
//				uint32_t a0, a1;
//
//				a0 = a[v];
//				a1 = a[v + ht];
//				a[v] = mq_add(a0, a1, Qt);
//				a[v + ht] = mq_montymul(
//					mq_sub(a0, a1, Qt), s, Qt, Q0It);
//			}
//		}
//		t <<= 1;
//	}
//
//	/*
//	 * Modulo X^2-X+1.
//	 */
//	r = iGMt_square[0];
//	for (u = 0; u < hn; u ++) {
//		uint32_t a0, a1, b;
//
//		a0 = a[u];
//		a1 = a[u + hn];
//		b = mq_montymul(r, mq_sub(a0, a1, Qt), Qt, Q0It);
//		a[u] = mq_sub(mq_add(a0, a1, Qt), b, Qt);
//		a[u + hn] = mq_add(b, b, Qt);
//	}
//
//	/*
//	 * Corrective factor: all values have been (cumulatively)
//	 * multiplied by n. Inverses of n modulo q have been precomputed.
//	 */
//	ni = INVNQt[logn];
//	for (u = 0; u < n; u ++) {
//		a[u] = mq_montymul(a[u], ni, Qt, Q0It);
//	}
//}

static void
mq_NTT(uint16_t *a, unsigned logn, int ternary)
{
//	if (ternary) {
		//mq_NTT_ternary(a, logn);
//	} else {
		mq_NTT_binary(a, logn);
//	}
}

static void
mq_iNTT(uint16_t *a, unsigned logn, int ternary)
{
//	if (ternary) {
		//mq_iNTT_ternary(a, logn);
//	} else {
		mq_iNTT_binary(a, logn);
//	}
}

/*
 * Convert a polynomial (mod q) to Montgomery representation.
 */
static void
mq_poly_tomonty(uint16_t *f, unsigned logn, int ternary)
{
	size_t u, n;

	if (ternary) {
		n = (size_t)3 << (logn - 1);
		for (u = 0; u < n; u ++) {
			f[u] = (uint16_t)mq_montymul(f[u], R2t, Qt, Q0It);
		}
	} else {
		n = (size_t)1 << logn;
		for (u = 0; u < n; u ++) {
			f[u] = (uint16_t)mq_montymul(f[u], R2b, Qb, Q0Ib);
		}
	}
}

/*
 * Multiply two polynomials together (NTT representation, and using
 * a Montgomery multiplication). Result f*g is written over f.
 */
static void
mq_poly_montymul_ntt(uint16_t *f, const uint16_t *g, unsigned logn, int ternary)
{
	size_t u, n;

//	if (ternary) {
//		n = (size_t)3 << (logn - 1);
//		for (u = 0; u < n; u ++) {
//			f[u] = (uint16_t)mq_montymul(f[u], g[u], Qt, Q0It);
//		}
//	} else {
		n = (size_t)1 << logn;
		for (u = 0; u < n; u ++) {
			f[u] = (uint16_t)mq_montymul(f[u], g[u], Qb, Q0Ib);
		}
//	}
}

/*
 * Subtract polynomial g from polynomial f.
 */
static void
mq_poly_sub(uint16_t *f, const uint16_t *g, unsigned logn, int ternary)
{
	size_t u, n;

//	if (ternary) {
//		n = (size_t)3 << (logn - 1);
//		for (u = 0; u < n; u ++) {
//			f[u] = (uint16_t)mq_sub(f[u], g[u], Qt);
//		}
//	} else {
		n = (size_t)1 << logn;
		for (u = 0; u < n; u ++) {
			f[u] = (uint16_t)mq_sub(f[u], g[u], Qb);
		}
//	}
}

/* ===================================================================== */

/*
 * Falcon verification context: it contains the decoded public key,
 * and the running hash context.
 */
//struct falcon_vrfy_ {
//	shake_context sc;
//	uint16_t h[1024];
//	unsigned logn;
//	int ternary;
//};

/* see falcon.h */
//falcon_vrfy *
//falcon_vrfy_new(void)
//{
//	falcon_vrfy *fv;
//
//	fv = malloc(sizeof *fv);
//	if (fv == NULL) {
//		return NULL;
//	}
//	fv->logn = 0;
//	fv->ternary = 0;
//	return fv;
//}

/* see falcon.h */
void
falcon_vrfy_free(falcon_vrfy *fv)
{
	if (fv != NULL) {
		free(fv);
	}
}

/* see falcon.h */
int
falcon_vrfy_set_public_key(falcon_vrfy *fv,
	const void *pkey, size_t len)
{
	const unsigned char *buf;
	unsigned fb;

	buf = pkey;

	/*
	 * Read first byte: it defines the modulus and degree:
	 *   t 000 dddd
	 *   ^ ^^^ ^^^^
	 *   |  |    |
	 *   |  |    +----- degree log, over four bits (1 to 10 only)
	 *   |  |
	 *   |  |
	 *   |  |
	 *   |  +---------- reserved, must be 0
	 *   |
	 *   +------------- 1 for ternary, 0 for binary
	 */
	if (len <= 1) {
		goto bad_pkey;
	}
	fb = *buf ++;
	len --;
	fv->logn = fb & 0x0F;
	if ((fb >> 7) != 0) {
		fv->ternary = 1;
		if (fv->logn < 2 || fv->logn > 9) {
			goto bad_pkey;
		}
	} else {
		fv->ternary = 0;
		if (fv->logn < 1 || fv->logn > 10) {
			goto bad_pkey;
		}
	}
	if (((fb >> 4) & 0x07) != 0) {
		goto bad_pkey;
	}

	/*
	 * Decode public vector.
	 */
//	if (fv->ternary) {
//		if (falcon_decode_18433(fv->h, fv->logn, buf, len) != len) {
//			goto bad_pkey;
//		}
//	} else {
		if (falcon_decode_12289(fv->h, fv->logn, buf, len) != len) {
			goto bad_pkey;
		}
//	}

	/*
	 * We apply NTT and Montgomery representation immediately, since
	 * it will be used for signature verification.
	 * (Conceptually this could be part of the public key encoding,
	 * but it would require making both NTT and Montgomery
	 * representations part of the specification.)
	 */
	mq_NTT(fv->h, fv->logn, fv->ternary);
	mq_poly_tomonty(fv->h, fv->logn, fv->ternary);
	return 1;

bad_pkey:
	fv->logn = 0;
	return 0;
}

/* see falcon.h */
void
falcon_vrfy_start(falcon_vrfy *fv, const void *r, size_t rlen)
{
	/*
	 * We use SHAKE-256, which has an internal capacity of 512 bits.
	 */
	shake_init(&fv->sc, 512);
	shake_inject(&fv->sc, r, rlen);
}

/* see falcon.h */
void
falcon_vrfy_update(falcon_vrfy *fv, const void *data, size_t len)
{
	shake_inject(&fv->sc, data, len);
}

/* see internal.h */
int
falcon_vrfy_verify_raw(const uint16_t *c0, const int16_t *s2,
	const uint16_t *h, unsigned logn, int ternary)
{
	uint16_t x[1024];
	size_t u, n;
	uint32_t q;

	if (ternary) {
		n = (size_t)3 << (logn - 1);
		q = Qt;
	} else {
		n = (size_t)1 << logn;
		q = Qb;
	}

	/*
	 * Reduce s2 elements modulo q ([0..q-1] range).
	 */
	for (u = 0; u < n; u ++) {
		uint32_t w;

		w = (uint32_t)s2[u];
		w += q & -(w >> 31);
		x[u] = (uint16_t)w;
	}

	/*
	 * Compute s1 = s2*h - c0 mod phi mod q (in x[]).
	 */
	mq_NTT(x, logn, ternary);
	mq_poly_montymul_ntt(x, h, logn, ternary);
	mq_iNTT(x, logn, ternary);
	mq_poly_sub(x, c0, logn, ternary);

	/*
	 * Normalize s1 elements into the [-q/2..q/2] range.
	 */
	for (u = 0; u < n; u ++) {
		int32_t w;

		w = (int32_t)x[u];
		w -= (int32_t)(q & -(((q >> 1) - (uint32_t)w) >> 31));
		((int16_t *)x)[u] = (int16_t)w;
	}

	/*
	 * Signature is valid if and only if the aggregate (s1,s2) vector
	 * is short enough.
	 */
	return falcon_is_short((int16_t *)x, s2, logn, ternary);
}

/* see falcon.h */
int
falcon_vrfy_verify(falcon_vrfy *fv, const void *sig, size_t len)
{
	const unsigned char *sig_buf;
	unsigned q;
	int fb;
	uint16_t c0[1024];
	int16_t s2[1024];

	/*
	 * Public key must have been set.
	 */
	if (fv->logn == 0) {
		return -2;
	}

	/*
	 * Signature cannot be too short.
	 */
	if (len <= 2) {
		return -1;
	}

	/*
	 * Read first byte: it defines the modulus and degree:
	 *   t cc 0 dddd
	 *   ^ ^^ ^ ^^^^
	 *   |  | |   |
	 *   |  | |   +----- degree log, over four bits (1 to 10 only)
	 *   |  | |
	 *   |  | +--------- reserved, must be 0
	 *   |  |
	 *   |  +----------- compression type
	 *   |
	 *   +-------------- 1 for ternary, 0 for binary
	 *
	 * Compression is:
	 *   00   uncompressed, 16 bits per integer (signed)
	 *   01   compressed with static codes
	 * Other compression values are reserved.
	 */
	sig_buf = sig;
	fb = *sig_buf ++;
	len --;

	/* Check reserved bit. */
	if ((fb & 0x10) != 0) {
		return -1;
	}

	/* Check degree. */
	if ((fb & 0x0F) != fv->logn) {
		return -1;
	}
	if ((fb >> 7) != fv->ternary) {
		return -1;
	}
//	q = fv->ternary ? Qt : Qb;
	q = Qb;
	/* Decode value. */
	if (falcon_decode_small(s2, fv->logn,
		(fb >> 5) & 0x03, q, sig_buf, len) != len)
	{
		return -1;
	}

	/*
	 * Hash the message into a vector, then verify the signature.
	 */
	shake_flip(&fv->sc);
	falcon_hash_to_point(&fv->sc, q, c0, fv->logn);
	return (int)falcon_vrfy_verify_raw(
		c0, s2, fv->h, fv->logn, fv->ternary);
}

/* see internal.h */
int
falcon_compute_public(uint16_t *h,
	const int16_t *f, const int16_t *g, unsigned logn, int ternary)
{
	size_t u, n;
	uint16_t t[1024];
	uint32_t q;
	int loop2;

	if (ternary) {
		n = (size_t)3 << (logn - 1);
		q = Qt;
	} else {
		n = (size_t)1 << logn;
		q = Qb;
	}
	for (u = 0; u < n; u ++) {
		t[u] = mq_conv_small(f[u], q);
		h[u] = mq_conv_small(g[u], q);
	}
	mq_NTT(h, logn, ternary);
	mq_NTT(t, logn, ternary);
	for (u = 0; u < n; u ++) {
		if (t[u] == 0) {
			return 0;
		}
		h[u] = ternary
			? mq_div_18433(h[u], t[u])
			: mq_div_12289(h[u], t[u]);
	}
//	for(loop2=0;loop2<1024;loop2++)
//		printf("h[%d] = %d; ",loop2,h[loop2]);
//	printf("\n");
//	h[0] = 9822; h[1] = 2213; h[2] = 907; h[3] = 11241; h[4] = 4706; h[5] = 1761; h[6] = 3585; h[7] = 6401; h[8] = 6477; h[9] = 3780; h[10] = 4472; h[11] = 6597; h[12] = 8775; h[13] = 11540; h[14] = 5399; h[15] = 9278; h[16] = 6675; h[17] = 7747; h[18] = 3514; h[19] = 1486; h[20] = 792; h[21] = 6389; h[22] = 6327; h[23] = 11034; h[24] = 915; h[25] = 7275; h[26] = 63; h[27] = 6661; h[28] = 1140; h[29] = 4200; h[30] = 5087; h[31] = 8739; h[32] = 9802; h[33] = 3325; h[34] = 2106; h[35] = 2028; h[36] = 8797; h[37] = 8646; h[38] = 699; h[39] = 5377; h[40] = 11888; h[41] = 1693; h[42] = 10929; h[43] = 12090; h[44] = 6148; h[45] = 3894; h[46] = 6375; h[47] = 12182; h[48] = 6109; h[49] = 3577; h[50] = 6232; h[51] = 11368; h[52] = 3456; h[53] = 9581; h[54] = 2951; h[55] = 5170; h[56] = 5770; h[57] = 4334; h[58] = 10037; h[59] = 1772; h[60] = 7255; h[61] = 11736; h[62] = 8311; h[63] = 7825; h[64] = 11068; h[65] = 3796; h[66] = 1097; h[67] = 6940; h[68] = 7605; h[69] = 1222; h[70] = 4008; h[71] = 7632; h[72] = 1957; h[73] = 8096; h[74] = 11680; h[75] = 5311; h[76] = 11534; h[77] = 561; h[78] = 10142; h[79] = 7455; h[80] = 10514; h[81] = 9617; h[82] = 6256; h[83] = 7968; h[84] = 3367; h[85] = 2687; h[86] = 8200; h[87] = 1711; h[88] = 1328; h[89] = 7440; h[90] = 10345; h[91] = 8773; h[92] = 9262; h[93] = 34; h[94] = 9885; h[95] = 7556; h[96] = 12070; h[97] = 4152; h[98] = 10900; h[99] = 424; h[100] = 2702; h[101] = 1331; h[102] = 3660; h[103] = 350; h[104] = 1498; h[105] = 964; h[106] = 8850; h[107] = 719; h[108] = 8078; h[109] = 2442; h[110] = 6102; h[111] = 1579; h[112] = 1191; h[113] = 12020; h[114] = 3175; h[115] = 6234; h[116] = 2213; h[117] = 1395; h[118] = 1059; h[119] = 3714; h[120] = 59; h[121] = 5512; h[122] = 2816; h[123] = 54; h[124] = 508; h[125] = 6377; h[126] = 7485; h[127] = 1795; h[128] = 1764; h[129] = 10503; h[130] = 6338; h[131] = 10756; h[132] = 5292; h[133] = 11052; h[134] = 171; h[135] = 608; h[136] = 994; h[137] = 7148; h[138] = 4127; h[139] = 10057; h[140] = 1380; h[141] = 8424; h[142] = 10898; h[143] = 10041; h[144] = 6816; h[145] = 1649; h[146] = 11159; h[147] = 6076; h[148] = 4688; h[149] = 7726; h[150] = 3482; h[151] = 8321; h[152] = 945; h[153] = 9064; h[154] = 3136; h[155] = 6842; h[156] = 9416; h[157] = 1889; h[158] = 10942; h[159] = 6350; h[160] = 3861; h[161] = 2725; h[162] = 5395; h[163] = 9395; h[164] = 502; h[165] = 7037; h[166] = 2677; h[167] = 4358; h[168] = 7635; h[169] = 3839; h[170] = 3983; h[171] = 3592; h[172] = 7714; h[173] = 235; h[174] = 9647; h[175] = 9538; h[176] = 2935; h[177] = 838; h[178] = 12059; h[179] = 6319; h[180] = 5667; h[181] = 6466; h[182] = 9288; h[183] = 10183; h[184] = 3107; h[185] = 11413; h[186] = 800; h[187] = 4070; h[188] = 3072; h[189] = 7298; h[190] = 7770; h[191] = 10685; h[192] = 9852; h[193] = 6238; h[194] = 1139; h[195] = 8209; h[196] = 3974; h[197] = 6312; h[198] = 5509; h[199] = 1983; h[200] = 2275; h[201] = 12271; h[202] = 2327; h[203] = 4308; h[204] = 3931; h[205] = 11036; h[206] = 10636; h[207] = 10419; h[208] = 11703; h[209] = 10950; h[210] = 8264; h[211] = 74; h[212] = 2824; h[213] = 4641; h[214] = 3013; h[215] = 10447; h[216] = 3454; h[217] = 6184; h[218] = 8214; h[219] = 895; h[220] = 5907; h[221] = 5056; h[222] = 9804; h[223] = 10222; h[224] = 10757; h[225] = 10302; h[226] = 2405; h[227] = 8381; h[228] = 7991; h[229] = 9483; h[230] = 11909; h[231] = 8205; h[232] = 3083; h[233] = 5432; h[234] = 5894; h[235] = 7930; h[236] = 11868; h[237] = 10814; h[238] = 8064; h[239] = 12105; h[240] = 5305; h[241] = 5793; h[242] = 11697; h[243] = 9916; h[244] = 8996; h[245] = 6515; h[246] = 918; h[247] = 4260; h[248] = 3624; h[249] = 23; h[250] = 9634; h[251] = 4246; h[252] = 2799; h[253] = 10551; h[254] = 10294; h[255] = 6938; h[256] = 6916; h[257] = 10847; h[258] = 2375; h[259] = 2393; h[260] = 4869; h[261] = 9513; h[262] = 1645; h[263] = 7172; h[264] = 1148; h[265] = 8083; h[266] = 10726; h[267] = 11578; h[268] = 8843; h[269] = 660; h[270] = 5107; h[271] = 10998; h[272] = 633; h[273] = 9347; h[274] = 9194; h[275] = 4260; h[276] = 4806; h[277] = 4356; h[278] = 5745; h[279] = 3662; h[280] = 3182; h[281] = 9813; h[282] = 6741; h[283] = 1056; h[284] = 714; h[285] = 1548; h[286] = 7019; h[287] = 1186; h[288] = 4385; h[289] = 61; h[290] = 7222; h[291] = 7299; h[292] = 7123; h[293] = 10374; h[294] = 5569; h[295] = 11979; h[296] = 9437; h[297] = 8289; h[298] = 10335; h[299] = 3479; h[300] = 423; h[301] = 5303; h[302] = 7093; h[303] = 3487; h[304] = 2031; h[305] = 9821; h[306] = 4190; h[307] = 9392; h[308] = 8208; h[309] = 643; h[310] = 8003; h[311] = 9439; h[312] = 5448; h[313] = 12049; h[314] = 3417; h[315] = 8745; h[316] = 2654; h[317] = 6110; h[318] = 11274; h[319] = 8035; h[320] = 6814; h[321] = 8049; h[322] = 11481; h[323] = 1503; h[324] = 4874; h[325] = 506; h[326] = 5890; h[327] = 10681; h[328] = 10852; h[329] = 2053; h[330] = 3491; h[331] = 5757; h[332] = 9090; h[333] = 6277; h[334] = 2354; h[335] = 2484; h[336] = 2390; h[337] = 8580; h[338] = 3258; h[339] = 9315; h[340] = 2337; h[341] = 7612; h[342] = 11013; h[343] = 9464; h[344] = 9981; h[345] = 1554; h[346] = 7102; h[347] = 8669; h[348] = 6701; h[349] = 3387; h[350] = 8766; h[351] = 7506; h[352] = 4200; h[353] = 8812; h[354] = 2414; h[355] = 9633; h[356] = 9841; h[357] = 10543; h[358] = 5041; h[359] = 4233; h[360] = 3906; h[361] = 8104; h[362] = 168; h[363] = 9535; h[364] = 9751; h[365] = 4360; h[366] = 3169; h[367] = 6364; h[368] = 6864; h[369] = 10226; h[370] = 10558; h[371] = 10623; h[372] = 12091; h[373] = 8406; h[374] = 4553; h[375] = 10119; h[376] = 8368; h[377] = 11855; h[378] = 9353; h[379] = 3413; h[380] = 1503; h[381] = 10296; h[382] = 3079; h[383] = 11750; h[384] = 11391; h[385] = 8252; h[386] = 4853; h[387] = 9644; h[388] = 12059; h[389] = 32; h[390] = 5645; h[391] = 6010; h[392] = 7976; h[393] = 11234; h[394] = 12128; h[395] = 5118; h[396] = 6983; h[397] = 4579; h[398] = 4223; h[399] = 10919; h[400] = 10539; h[401] = 5786; h[402] = 9093; h[403] = 1072; h[404] = 7604; h[405] = 7262; h[406] = 5784; h[407] = 88; h[408] = 4478; h[409] = 4974; h[410] = 5017; h[411] = 10100; h[412] = 142; h[413] = 1714; h[414] = 11852; h[415] = 6785; h[416] = 6438; h[417] = 8594; h[418] = 6585; h[419] = 10958; h[420] = 1244; h[421] = 802; h[422] = 1219; h[423] = 7594; h[424] = 4312; h[425] = 11103; h[426] = 7524; h[427] = 11301; h[428] = 10174; h[429] = 9646; h[430] = 1415; h[431] = 4182; h[432] = 11101; h[433] = 1320; h[434] = 7391; h[435] = 9540; h[436] = 9091; h[437] = 3565; h[438] = 7885; h[439] = 12047; h[440] = 10434; h[441] = 10943; h[442] = 1773; h[443] = 8865; h[444] = 9636; h[445] = 2819; h[446] = 5248; h[447] = 8336; h[448] = 11964; h[449] = 1788; h[450] = 7694; h[451] = 2218; h[452] = 5623; h[453] = 7071; h[454] = 666; h[455] = 4171; h[456] = 8337; h[457] = 3561; h[458] = 6063; h[459] = 11738; h[460] = 11432; h[461] = 3006; h[462] = 11600; h[463] = 11366; h[464] = 11508; h[465] = 1019; h[466] = 2485; h[467] = 5319; h[468] = 10688; h[469] = 2745; h[470] = 1706; h[471] = 1723; h[472] = 4121; h[473] = 4412; h[474] = 860; h[475] = 6200; h[476] = 6152; h[477] = 4005; h[478] = 7987; h[479] = 9012; h[480] = 10635; h[481] = 3543; h[482] = 5710; h[483] = 5613; h[484] = 3670; h[485] = 284; h[486] = 2996; h[487] = 3106; h[488] = 4889; h[489] = 7593; h[490] = 3142; h[491] = 3961; h[492] = 10507; h[493] = 6950; h[494] = 8549; h[495] = 7813; h[496] = 10024; h[497] = 5347; h[498] = 3717; h[499] = 7866; h[500] = 3269; h[501] = 1953; h[502] = 10456; h[503] = 979; h[504] = 3616; h[505] = 9099; h[506] = 2298; h[507] = 269; h[508] = 5700; h[509] = 10774; h[510] = 7288; h[511] = 9905; h[512] = 0; h[513] = 0; h[514] = 0; h[515] = 0; h[516] = 0; h[517] = 0; h[518] = 0; h[519] = 0; h[520] = 0; h[521] = 0; h[522] = 0; h[523] = 0; h[524] = 0; h[525] = 0; h[526] = 0; h[527] = 0; h[528] = 0; h[529] = 0; h[530] = 0; h[531] = 0; h[532] = 0; h[533] = 0; h[534] = 0; h[535] = 0; h[536] = 0; h[537] = 0; h[538] = 0; h[539] = 0; h[540] = 0; h[541] = 0; h[542] = 0; h[543] = 0; h[544] = 0; h[545] = 0; h[546] = 0; h[547] = 0; h[548] = 0; h[549] = 0; h[550] = 0; h[551] = 0; h[552] = 0; h[553] = 0; h[554] = 0; h[555] = 0; h[556] = 0; h[557] = 0; h[558] = 0; h[559] = 0; h[560] = 0; h[561] = 0; h[562] = 0; h[563] = 0; h[564] = 0; h[565] = 0; h[566] = 0; h[567] = 0; h[568] = 0; h[569] = 0; h[570] = 0; h[571] = 0; h[572] = 0; h[573] = 0; h[574] = 0; h[575] = 0; h[576] = 0; h[577] = 0; h[578] = 0; h[579] = 0; h[580] = 0; h[581] = 0; h[582] = 0; h[583] = 0; h[584] = 0; h[585] = 0; h[586] = 0; h[587] = 0; h[588] = 0; h[589] = 0; h[590] = 0; h[591] = 0; h[592] = 0; h[593] = 0; h[594] = 0; h[595] = 0; h[596] = 0; h[597] = 0; h[598] = 0; h[599] = 0; h[600] = 0; h[601] = 0; h[602] = 0; h[603] = 0; h[604] = 0; h[605] = 0; h[606] = 0; h[607] = 0; h[608] = 0; h[609] = 0; h[610] = 0; h[611] = 0; h[612] = 0; h[613] = 0; h[614] = 0; h[615] = 0; h[616] = 0; h[617] = 0; h[618] = 0; h[619] = 0; h[620] = 0; h[621] = 0; h[622] = 0; h[623] = 0; h[624] = 0; h[625] = 0; h[626] = 0; h[627] = 0; h[628] = 0; h[629] = 0; h[630] = 0; h[631] = 0; h[632] = 0; h[633] = 0; h[634] = 0; h[635] = 0; h[636] = 0; h[637] = 0; h[638] = 0; h[639] = 0; h[640] = 0; h[641] = 0; h[642] = 0; h[643] = 0; h[644] = 0; h[645] = 0; h[646] = 0; h[647] = 0; h[648] = 0; h[649] = 0; h[650] = 0; h[651] = 0; h[652] = 0; h[653] = 0; h[654] = 0; h[655] = 0; h[656] = 0; h[657] = 0; h[658] = 0; h[659] = 0; h[660] = 0; h[661] = 0; h[662] = 0; h[663] = 0; h[664] = 0; h[665] = 0; h[666] = 0; h[667] = 0; h[668] = 0; h[669] = 0; h[670] = 0; h[671] = 0; h[672] = 0; h[673] = 0; h[674] = 0; h[675] = 0; h[676] = 0; h[677] = 0; h[678] = 0; h[679] = 0; h[680] = 0; h[681] = 0; h[682] = 0; h[683] = 0; h[684] = 0; h[685] = 0; h[686] = 0; h[687] = 0; h[688] = 0; h[689] = 0; h[690] = 0; h[691] = 0; h[692] = 0; h[693] = 0; h[694] = 0; h[695] = 0; h[696] = 0; h[697] = 0; h[698] = 0; h[699] = 0; h[700] = 0; h[701] = 0; h[702] = 0; h[703] = 0; h[704] = 0; h[705] = 0; h[706] = 0; h[707] = 0; h[708] = 0; h[709] = 0; h[710] = 0; h[711] = 0; h[712] = 0; h[713] = 0; h[714] = 0; h[715] = 0; h[716] = 0; h[717] = 0; h[718] = 0; h[719] = 0; h[720] = 0; h[721] = 0; h[722] = 0; h[723] = 0; h[724] = 0; h[725] = 0; h[726] = 0; h[727] = 0; h[728] = 0; h[729] = 0; h[730] = 0; h[731] = 0; h[732] = 0; h[733] = 0; h[734] = 0; h[735] = 0; h[736] = 0; h[737] = 0; h[738] = 0; h[739] = 0; h[740] = 0; h[741] = 0; h[742] = 0; h[743] = 0; h[744] = 0; h[745] = 0; h[746] = 0; h[747] = 0; h[748] = 0; h[749] = 0; h[750] = 0; h[751] = 0; h[752] = 0; h[753] = 0; h[754] = 0; h[755] = 0; h[756] = 0; h[757] = 0; h[758] = 0; h[759] = 0; h[760] = 0; h[761] = 0; h[762] = 0; h[763] = 0; h[764] = 0; h[765] = 0; h[766] = 0; h[767] = 0; h[768] = 0; h[769] = 0; h[770] = 0; h[771] = 0; h[772] = 0; h[773] = 0; h[774] = 0; h[775] = 0; h[776] = 0; h[777] = 0; h[778] = 0; h[779] = 0; h[780] = 0; h[781] = 0; h[782] = 0; h[783] = 0; h[784] = 0; h[785] = 0; h[786] = 0; h[787] = 0; h[788] = 0; h[789] = 0; h[790] = 0; h[791] = 0; h[792] = 0; h[793] = 0; h[794] = 0; h[795] = 0; h[796] = 0; h[797] = 0; h[798] = 0; h[799] = 0; h[800] = 0; h[801] = 0; h[802] = 0; h[803] = 0; h[804] = 0; h[805] = 0; h[806] = 0; h[807] = 0; h[808] = 0; h[809] = 0; h[810] = 0; h[811] = 0; h[812] = 0; h[813] = 0; h[814] = 0; h[815] = 0; h[816] = 0; h[817] = 0; h[818] = 0; h[819] = 0; h[820] = 0; h[821] = 0; h[822] = 0; h[823] = 0; h[824] = 0; h[825] = 0; h[826] = 0; h[827] = 0; h[828] = 0; h[829] = 0; h[830] = 0; h[831] = 0; h[832] = 0; h[833] = 0; h[834] = 0; h[835] = 0; h[836] = 0; h[837] = 0; h[838] = 0; h[839] = 0; h[840] = 0; h[841] = 0; h[842] = 0; h[843] = 0; h[844] = 0; h[845] = 0; h[846] = 0; h[847] = 0; h[848] = 0; h[849] = 0; h[850] = 0; h[851] = 0; h[852] = 0; h[853] = 0; h[854] = 0; h[855] = 0; h[856] = 0; h[857] = 0; h[858] = 0; h[859] = 0; h[860] = 0; h[861] = 0; h[862] = 0; h[863] = 0; h[864] = 0; h[865] = 0; h[866] = 0; h[867] = 0; h[868] = 0; h[869] = 0; h[870] = 0; h[871] = 0; h[872] = 0; h[873] = 0; h[874] = 0; h[875] = 0; h[876] = 0; h[877] = 0; h[878] = 0; h[879] = 0; h[880] = 0; h[881] = 0; h[882] = 0; h[883] = 0; h[884] = 0; h[885] = 0; h[886] = 0; h[887] = 0; h[888] = 0; h[889] = 0; h[890] = 0; h[891] = 0; h[892] = 0; h[893] = 0; h[894] = 0; h[895] = 0; h[896] = 0; h[897] = 0; h[898] = 0; h[899] = 0; h[900] = 0; h[901] = 0; h[902] = 0; h[903] = 0; h[904] = 0; h[905] = 0; h[906] = 0; h[907] = 0; h[908] = 0; h[909] = 0; h[910] = 0; h[911] = 0; h[912] = 0; h[913] = 0; h[914] = 0; h[915] = 0; h[916] = 0; h[917] = 0; h[918] = 0; h[919] = 0; h[920] = 0; h[921] = 0; h[922] = 0; h[923] = 0; h[924] = 0; h[925] = 0; h[926] = 0; h[927] = 0; h[928] = 0; h[929] = 0; h[930] = 0; h[931] = 0; h[932] = 0; h[933] = 0; h[934] = 0; h[935] = 0; h[936] = 0; h[937] = 0; h[938] = 0; h[939] = 0; h[940] = 0; h[941] = 0; h[942] = 0; h[943] = 0; h[944] = 0; h[945] = 0; h[946] = 0; h[947] = 0; h[948] = 0; h[949] = 0; h[950] = 0; h[951] = 0; h[952] = 0; h[953] = 0; h[954] = 0; h[955] = 0; h[956] = 0; h[957] = 0; h[958] = 0; h[959] = 0; h[960] = 0; h[961] = 0; h[962] = 0; h[963] = 0; h[964] = 0; h[965] = 0; h[966] = 0; h[967] = 0; h[968] = 0; h[969] = 0; h[970] = 0; h[971] = 0; h[972] = 0; h[973] = 0; h[974] = 0; h[975] = 0; h[976] = 0; h[977] = 0; h[978] = 0; h[979] = 0; h[980] = 0; h[981] = 0; h[982] = 0; h[983] = 0; h[984] = 0; h[985] = 0; h[986] = 0; h[987] = 0; h[988] = 0; h[989] = 0; h[990] = 0; h[991] = 0; h[992] = 0; h[993] = 0; h[994] = 0; h[995] = 0; h[996] = 0; h[997] = 0; h[998] = 0; h[999] = 0; h[1000] = 0; h[1001] = 0; h[1002] = 0; h[1003] = 0; h[1004] = 0; h[1005] = 0; h[1006] = 0; h[1007] = 0; h[1008] = 0; h[1009] = 0; h[1010] = 0; h[1011] = 0; h[1012] = 0; h[1013] = 0; h[1014] = 0; h[1015] = 0; h[1016] = 0; h[1017] = 0; h[1018] = 0; h[1019] = 0; h[1020] = 0; h[1021] = 0; h[1022] = 0; h[1023] = 0;
	//mq_iNTT(h, logn, ternary);
	mq_iNTT_binary(h, logn);
	return 1;
}

/* see internal.h */
int
falcon_complete_private(int16_t *G,
	const int16_t *f, const int16_t *g, const int16_t *F,
	unsigned logn, int ternary)
{
	size_t u, n;
	uint16_t t1[1024], t2[1024];
	uint32_t q;

	if (ternary) {
		n = (size_t)3 << (logn - 1);
		q = Qt;
	} else {
		n = (size_t)1 << logn;
		q = Qb;
	}
	for (u = 0; u < n; u ++) {
		t1[u] = mq_conv_small(g[u], q);
		t2[u] = mq_conv_small(F[u], q);
	}
	mq_NTT(t1, logn, ternary);
	mq_NTT(t2, logn, ternary);
	mq_poly_tomonty(t1, logn, ternary);
	mq_poly_montymul_ntt(t1, t2, logn, ternary);
	for (u = 0; u < n; u ++) {
		t2[u] = mq_conv_small(f[u], q);
	}
	mq_NTT(t2, logn, ternary);
	for (u = 0; u < n; u ++) {
		if (t2[u] == 0) {
			return 0;
		}
		t1[u] = ternary
			? mq_div_18433(t1[u], t2[u])
			: mq_div_12289(t1[u], t2[u]);
	}
	mq_iNTT(t1, logn, ternary);
	for (u = 0; u < n; u ++) {
		uint32_t w;

		w = t1[u];
		G[u] = (int32_t)w - (int32_t)(q & ~-((w - (q >> 1)) >> 31));
	}
	return 1;
}
